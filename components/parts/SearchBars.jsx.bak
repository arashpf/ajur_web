import React, { useState, useRef, useEffect, useContext } from "react";
import axios from "axios";
import { CityContext } from "./CityContext";
import CitySelector from "./CitySelector";
import SearchIcon from "@mui/icons-material/Search";
import { useRouter } from "next/router";
import SmallCard from "../cards/SmallCard";
import { Snackbar, Alert } from "@mui/material";

const RealEstateCard = ({ realstate, circle_size }) => (
  <div className="bg-white p-4 rounded-lg shadow-md border border-gray-200">
    نمایش کارت املاک
  </div>
);

const suggestionsMap = {
  buySell: [
    "مثلا : خرید خانه ",
    "مثلا : ویلایی ",
    "مثلا تجاری ",
    "مثلا : اجاره آپارتمان",
  ],
  agents: [
    "جستجو مشاور : مثلا محمد دهقان",
    "جستجو مشاور املاک...",
    "مشاور املاک متخصص...",
  ],
  jobs: [
    "مثلا : نقاش ساختمان",
    "دکوراسیون داخلی",
    "مثلا : بنا",
    "مثلا : گچ کار",
  ],
};

const estateHints = [
  "آپارتمان",
  "خانه ویلایی",
  "زمین مسکونی",
  "مغازه",
  "اجاره آپارتمان",
  "اجاره خانه ویلایی",
  "باغ و باغچه",
  "زمین صنعتی",
];

const SEARCH_TIMEOUT = 15000;
const TYPING_DELAY = 600;

const categoriesData = [
  {
    id: 3,
    name: "خرید صنعتی",
    description: null,
    status: "1",
    has_parent: "0",
    has_child: "0",
    parent_id: "0",
    sort_order: "1",
    avatar: "industry",
    created_at: "2021-01-03T21:56:25.000000Z",
    updated_at: "2021-01-03T21:56:25.000000Z",
    type: "sell",
  },
  {
    id: 6,
    name: "اجاره صنعتی",
    description: "اجاره انواع واحد های صنعتی",
    status: "1",
    has_parent: "0",
    has_child: "0",
    parent_id: "0",
    sort_order: "27",
    avatar: "rent_industrial",
    created_at: "2024-04-06T16:01:02.000000Z",
    updated_at: "2024-04-06T16:01:02.000000Z",
    type: "rent",
  },
  {
    id: 16,
    name: "خرید آپارتمان",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "1",
    sort_order: "16",
    avatar: "sell_apartment",
    created_at: null,
    updated_at: null,
    type: "sell",
  },
  {
    id: 17,
    name: "خرید خانه ویلایی",
    description: "فروش انواع خانه های ویلایی",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "1",
    sort_order: "17",
    avatar: "sell_industrial_land",
    created_at: "2024-04-06T15:18:54.000000Z",
    updated_at: "2024-04-06T15:18:54.000000Z",
    type: "sell",
  },
  {
    id: 18,
    name: "خرید زمین مسکونی",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "18",
    avatar: "sell_residental_land",
    created_at: "2021-01-03T21:56:25.000000Z",
    updated_at: "2021-01-03T21:56:25.000000Z",
    type: "sell",
  },
  {
    id: 19,
    name: "خرید زمین تجاری و اداری",
    description: "دسته بندی زمین های تجاری و اداری",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "19",
    avatar: "sell_office_land",
    created_at: "2024-04-06T15:11:50.000000Z",
    updated_at: "2024-04-06T15:11:50.000000Z",
    type: "sell",
  },
  {
    id: 20,
    name: "خرید زمین صنعتی ",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "20",
    avatar: "sell_industrial_land",
    created_at: "2024-04-06T15:13:10.000000Z",
    updated_at: "2024-04-06T15:13:10.000000Z",
    type: "sell",
  },
  {
    id: 21,
    name: "خرید باغ و باغچه",
    description: "فروش انواع باغ و باغچه",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "21",
    avatar: "sell_industrial",
    created_at: "2024-04-06T15:54:38.000000Z",
    updated_at: "2024-04-06T15:54:38.000000Z",
    type: "sell",
  },
  {
    id: 22,
    name: "خرید زمین زراعی\n",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "22",
    avatar: "sell_farm_land",
    created_at: "2024-04-06T15:15:48.000000Z",
    updated_at: "2024-04-06T15:15:48.000000Z",
    type: "sell",
  },
  {
    id: 23,
    name: "خرید مغازه\n",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "4",
    sort_order: "23",
    avatar: "sell_store",
    created_at: "2024-04-06T15:48:19.000000Z",
    updated_at: "2024-04-06T15:48:19.000000Z",
    type: "sell",
  },
  {
    id: 24,
    name: "خرید دفتر کار و اداری",
    description: "انواع دفتر کار ، سالن و اداری",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "4",
    sort_order: "24",
    avatar: "sell_office",
    created_at: "2024-04-06T15:50:53.000000Z",
    updated_at: "2024-04-06T15:50:53.000000Z",
    type: "sell",
  },
  {
    id: 25,
    name: "اجاره آپارتمان",
    description: "اجاره انواع آپارتمان",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "5",
    sort_order: "25",
    avatar: "rent_apartment",
    created_at: "2024-04-06T15:59:02.000000Z",
    updated_at: "2024-04-06T15:59:02.000000Z",
    type: "rent",
  },
  {
    id: 26,
    name: "اجاره خانه ویلایی",
    description: "اجاره انواع خانه های ویلایی",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "5",
    sort_order: "26",
    avatar: "rent_villa",
    created_at: "2024-04-06T15:56:47.000000Z",
    updated_at: "2024-04-06T15:56:47.000000Z",
    type: "rent",
  },
  {
    id: 27,
    name: "اجاره مغازه",
    description: "اجاره انواع مغازه",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "7",
    sort_order: "27",
    avatar: "sell_store",
    created_at: "2024-04-06T16:08:35.000000Z",
    updated_at: "2024-04-06T16:08:35.000000Z",
    type: "rent",
  },
  {
    id: 28,
    name: "اجاره دفتر کار و اداری",
    description: "اجاره انواع دفتر کار، مطب و واحد اداری",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "7",
    sort_order: "28",
    avatar: "rent_office",
    created_at: "2024-04-06T16:09:35.000000Z",
    updated_at: "2024-04-06T16:09:35.000000Z",
    type: "rent",
  },
  {
    id: 65,
    name: "زمین هکتاری",
    description: "زمین هکتاری",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "1",
    avatar: "hectare_land",
    created_at: "2025-02-12T18:19:41.000000Z",
    updated_at: "2025-02-12T18:19:41.000000Z",
    type: "sell",
  },
];

const SearchBars = ({ realstates }) => {
  const router = useRouter();
  const { currentCity, isLoading } = useContext(CityContext);
  // State management
  const [activeTab, setActiveTab] = useState("buySell");
  const [searchQuery, setSearchQuery] = useState("");
  const [properties, setProperties] = useState([]);
  const [agents, setAgents] = useState([]);
  const [loading, setLoading] = useState(false);
  const [loadingAgents, setLoadingAgents] = useState(false);
  const [isRedirecting, setIsRedirecting] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [currentSuggestionIndex, setCurrentSuggestionIndex] = useState(0);
  const [isInputReady, setIsInputReady] = useState(false);
  const [searchStatus, setSearchStatus] = useState("جستجو...");
  const [networkStatus, setNetworkStatus] = useState({
    isConnected: true,
    isInternetReachable: true,
  });
  const [selectedCityName, setSelectedCityName] = useState();
  const [selectedCityId, setSelectedCityId] = useState();
  const [showCityModal, setShowCityModal] = useState(false);
  const [search_category, set_search_category] = useState([]);
  const [search_neighborhoods, set_search_neighborhoods] = useState([]);
  const [searchHistory, setSearchHistory] = useState([]);
  const [showAllNeighborhoods, setShowAllNeighborhoods] = useState(false);
  const [lastHintPressed, setLastHintPressed] = useState(null);
  const [suggestionDirection, setSuggestionDirection] = useState("down");
  const [snackOpen, setSnackOpen] = useState(false);
  const [snack, setSnack] = useState("");

  // Refs
  const inputRef = useRef(null);
  const suggestionIntervalRef = useRef(null);
  const loadingTimeoutRef = useRef(null);
  const progressIntervalRef = useRef(null);
  const typingTimeoutRef = useRef(null);


  const [cities, setCities] = useState([]);

  const getDefaultCities = () => [
    { id: 1, title: "تهران" },
    { id: 2, title: "رباط کریم" },
    { id: 3, title: "کرج" },
    { id: 4, title: "اصفهان" },
    { id: 5, title: "مشهد" },
  ];

  // Effects
  useEffect(() => {
    if (currentCity && !isLoading) {
      // fetchData(currentCity.id);
    }
  }, [currentCity, isLoading]);

  useEffect(() => {
    // Reset redirecting spinner when route changes complete
    const handleRouteChangeComplete = () => {
      setIsRedirecting(false);
    };

    router.events.on("routeChangeComplete", handleRouteChangeComplete);
    return () => {
      router.events.off("routeChangeComplete", handleRouteChangeComplete);
    };
  }, [router]);

  useEffect(() => {
    if (lastHintPressed) {
      handleSearch(true);
    }
  }, [lastHintPressed]);

  useEffect(() => {
    const loadSearchHistory = async () => {
      try {
        const history = localStorage.getItem("realEstateSearchHistory");
        if (history) {
          setSearchHistory(JSON.parse(history));
        }
      } catch (error) {
        console.error("Failed to load search history", error);
      }
    };
    loadSearchHistory();
  }, []);

  useEffect(() => {
    if (activeTab && !searchQuery && !showModal) {
      suggestionIntervalRef.current = setInterval(() => {
        setSuggestionDirection("up");

        setTimeout(() => {
          setCurrentSuggestionIndex((prev) =>
            prev >= suggestionsMap[activeTab].length - 1 ? 0 : prev + 1
          );

          setTimeout(() => {
            setSuggestionDirection("down");
          }, 100);
        }, 500);
      }, 3000);
    } else {
      clearInterval(suggestionIntervalRef.current);
      setCurrentSuggestionIndex(0);
      setSuggestionDirection("down");
    }
    return () => clearInterval(suggestionIntervalRef.current);
  }, [activeTab, searchQuery, showModal]);

  useEffect(() => {
    if (showModal) {
      const timer = setTimeout(() => {
        setIsInputReady(true);
        inputRef.current?.focus();
        // if (activeTab === "buySell") {
        //   fetch_cities_from_data_base()
        // }
      }, 300);
      return () => clearTimeout(timer);
    } else {
      setIsInputReady(false);
    }
  }, [showModal]);

  // Helper functions
  const handleSnackbar = (message) => {
    setSnack(message);
    setSnackOpen(true);
  };

  const renderSnackBar = () => {
    return (
      <Snackbar
        open={snackOpen}
        autoHideDuration={4000}
        onClose={() => setSnackOpen(false)}
        anchorOrigin={{ vertical: "top", horizontal: "center" }}
        sx={{
          "& .MuiSnackbarContent-root": {
            fontSize: "1.2rem", // Larger font
            padding: "16px 24px", // More padding
            minWidth: "400px", // Minimum width
          },
        }}
      >
        <Alert
          onClose={() => setSnackOpen(false)}
          severity="warning"
          sx={{ width: "100%" }}
        >
          {snack}
        </Alert>
      </Snackbar>
    );
  };


  const fetch_cities_from_data_base = async () =>  {
   
    try {
     
      const response = await axios.get(
        "https://api.ajur.app/api/search-cities",
        {
          params: { title: '' || "" },
          timeout: 5000,
        }
      );
      setCities(response.data?.items || getDefaultCities());
      console.log("now cities:", response.data?.items);
    } catch (error) {
      console.error("Error fetching cities:", error);
      setCities(getDefaultCities());
    } finally {
      
    }
  }

  const getCurrentSuggestion = () => {
    if (searchQuery) return searchQuery;
    if (!activeTab) return "جستجو...";
    return suggestionsMap[activeTab][currentSuggestionIndex] || "جستجو...";
  };

  const getNextSuggestion = () => {
    if (!activeTab) return "جستجو...";
    const nextIndex =
      currentSuggestionIndex >= suggestionsMap[activeTab].length - 1
        ? 0
        : currentSuggestionIndex + 1;
    return suggestionsMap[activeTab][nextIndex] || "جستجو...";
  };

  const saveToHistory = async (query) => {
    if (!query.trim()) return;
    try {
      const updatedHistory = [
        query,
        ...searchHistory.filter(
          (item) => item.toLowerCase() !== query.toLowerCase()
        ),
      ].slice(0, 10);
      setSearchHistory(updatedHistory);
      localStorage.setItem(
        "realEstateSearchHistory",
        JSON.stringify(updatedHistory)
      );
    } catch (error) {
      console.error("Failed to save search history", error);
    }
  };

  const handleTabPress = (tabId) => {
    if (tabId === "agents") {
      if (!currentCity || isLoading) {
        setSearchStatus("لطفاً ابتدا یک شهر را انتخاب کنید");
        return;
      }
      getAgentsCall("all", currentCity.id);
    }
    setActiveTab(tabId);
    setSearchQuery("");
    setSearchStatus("جستجو...");
  };

  const handleCloseModal = () => {
    setActiveTab("buySell");
    setShowModal(false);
    setIsRedirecting(false);
    clearTimeout(loadingTimeoutRef.current);
    clearInterval(progressIntervalRef.current);
  };

  const handleHintPress = (hint) => {
    setSearchQuery(hint);
    setLastHintPressed(hint);
    handleSearch(true);
  };

  const handleTextChange = (text) => {
    setSearchQuery(text);
    if (typingTimeoutRef.current) {
      clearTimeout(typingTimeoutRef.current);
    }
    if (text.trim().length > 0) {
      typingTimeoutRef.current = setTimeout(() => {
        handleSearch(false);
      }, TYPING_DELAY);
    }
  };

  const getAgentsCall = async (searchTerm) => {
    try {
      setLoadingAgents(true);
      setSearchStatus("در حال جستجوی مشاورین...");
      const response = await axios.get(
        "https://api.ajur.app/api/agents-search",
        {
          params: { title: searchTerm, limit: 20, city: currentCity.id },
          timeout: SEARCH_TIMEOUT,
        }
      );
      setAgents(response.data.agents || []);
      setSearchStatus(`${response.data.agents.length} مشاور یافت شد`);
    } catch (error) {
      console.error("Agent search failed:", error);
      setSearchStatus("خطا در جستجوی مشاورین");
    } finally {
      setLoadingAgents(false);
    }
  };

  const findCategoryById = (categoryId) => {
    return categoriesData.find((cat) => cat.id === categoryId);
  };

  const findCategoryByName = (categoryName) => {
    return categoriesData.find((cat) => {
      const normalizedInput = categoryName.replace(/\s+/g, " ").trim();
      const normalizedCatName = cat.name.replace(/\s+/g, " ").trim();
      return (
        normalizedCatName === normalizedInput ||
        normalizedCatName.includes(normalizedInput) ||
        normalizedInput.includes(normalizedCatName)
      );
    });
  };

  const sendToCat = (item, neighborhoodName = null) => {
    console.log("Item data:", item);

    handleCloseModal();

    let categoryId;
    let categoryName;

    if (item.category_array && typeof item.category_array === "object") {
      categoryId = item.category_array.id;
      categoryName = item.category_array.name || item.category;
    } else if (
      Array.isArray(item.category_array) &&
      item.category_array.length > 0
    ) {
      const firstCategory = item.category_array[0];
      if (typeof firstCategory === "object") {
        categoryId = firstCategory.id;
        categoryName = firstCategory.name || item.category;
      } else {
        categoryId = firstCategory;
        categoryName = item.category;
      }
    } else {
      categoryName = item.category;
      const foundCategory = findCategoryByName(categoryName);
      if (foundCategory) {
        categoryId = foundCategory.id;
      } else {
        console.error("No category found for item:", item);
        return;
      }
    }

    const queryParams = {
      name: categoryName,
      id: categoryId,
      categories: categoryId,
    };

    if (neighborhoodName) {
      queryParams.neighbor = neighborhoodName;
    }

    if (currentCity) {
      queryParams.city = currentCity.title;
    }

    console.log("Navigating to category page with params:", queryParams);

    const dynamicPathname = `/${currentCity.title}/${encodeURIComponent(
      categoryName
    )}`;

    // Show spinner during redirect
    setIsRedirecting(true);

    router.push({
      pathname: dynamicPathname,
      query: queryParams,
    });
  };

  const handleSearch = async (isManualSearch = true) => {
    if (!currentCity || isLoading) {
      setSearchStatus("لطفاً ابتدا یک شهر را انتخاب کنید");
      return;
    }
    if (!searchQuery.trim()) {
      return;
    }

    console.log(`Searching for "${searchQuery}" in ${activeTab} tab`);

    try {
      setLoading(true);
      setSearchStatus("در حال جستجو...");

      if (isManualSearch) {
        await saveToHistory(searchQuery);
      }

      progressIntervalRef.current = setInterval(() => {
        setSearchStatus((prev) =>
          prev.includes("...") ? "در حال جستجو" : prev + "."
        );
      }, 500);

      switch (activeTab) {
        case "buySell":
          try {
            const response = await axios.post(
              "https://api.ajur.app/api/search-intent",
              {
                query: searchQuery,
                cityid: currentCity.id,
              },
              { timeout: 10000 }
            );

            clearTimeout(loadingTimeoutRef.current);
            clearInterval(progressIntervalRef.current);

            if (!response.data || !Array.isArray(response.data)) {
              throw new Error("پاسخ نامعتبر از سرور دریافت شد");
            }

            const categoriesWithNeighborhoods = response.data;
            const allNeighborhoods =
              categoriesWithNeighborhoods.length > 0
                ? [
                    ...new Set(
                      categoriesWithNeighborhoods.flatMap((c) =>
                        c.neighborhoods.map((n) => n.name)
                      )
                    ),
                  ]
                : [];

            set_search_neighborhoods(allNeighborhoods);

           
            

            const displayItems = categoriesWithNeighborhoods.map(
              (categoryData, index) => {
                const categoryName = categoryData.category_name;
                const category_array = categoryData.category;
                const neighborhoods = categoryData.neighborhoods;

                return {
                  id: `category-${index}-${Date.now()}`,
                  category: categoryName,
                  category_array: category_array,
                  neighborhoods: neighborhoods,
                  propertyCounts: neighborhoods.reduce((acc, curr) => {
                    acc[curr.name] = curr.property_count;
                    return acc;
                  }, {}),
                  filters: { category_name: categoryName },
                  chips: neighborhoods
                    .filter((n) => n.property_count > 0)
                    .slice(0, 5)
                    .map((n) => ({
                      label: `${n.name} (${n.property_count})`,
                      value: n.name,
                    })),
                  isEmpty: neighborhoods.every((n) => n.property_count === 0),
                  isPrimary: index === 0,
                };
              }
            );

            if (displayItems.length === 0) {
              displayItems.push({
                id: "default-category",
                category: "",
                neighborhoods: [],
                propertyCounts: {},
                filters: {},
                chips: [],
                isEmpty: true,
                isPrimary: true,
              });
            }

            setProperties(displayItems);

            const statusText =
              categoriesWithNeighborhoods.length > 0
                ? `دسته‌بندی‌ها: ${categoriesWithNeighborhoods
                    .map((c) => c.category_name)
                    .join("، ")} در ${currentCity.title}`
                : `جستجوی عمومی در ${currentCity.title}`;

            setSearchStatus(statusText);
          } catch (error) {
            console.error("Search error:", error);
            setSearchStatus("خطایی در دریافت اطلاعات رخ داده است");
          }
          break;

        case "agents":
          await getAgentsCall(searchQuery);
          break;

        case "jobs":
          setSearchStatus("جستجوی مشاغل انجام شد");
          break;

        default:
          setSearchStatus("لطفاً یک تب معتبر را انتخاب کنید");
          return;
      }
    } catch (error) {
      console.error("Search error:", error);
      clearTimeout(loadingTimeoutRef.current);
      clearInterval(progressIntervalRef.current);
      setSearchStatus("خطا در جستجو");
    } finally {
      setLoading(false);
    }
  };

  const set_modal_active = (status) => {
    if (!currentCity || isLoading) {
      handleSnackbar("لطفاً ابتدا یک شهر را انتخاب کنید");
      // Trigger the CitySelector modal to open
      const citySelectorButton = document.querySelector(
        '[data-testid="citySelectorButton"]'
      );
      if (citySelectorButton) {
        citySelectorButton.click();
      }
      return;
    }
    setShowAllNeighborhoods(false);
    setProperties([]);
    setSearchQuery("");
    setShowModal(true);

    const timer = setTimeout(() => {
      setIsInputReady(true);
      inputRef.current?.focus();
    }, 500);
    return () => clearTimeout(timer);
  };

  const handleHomeClick = () => {
    router.push("/");
  };

  const renderSpinner = () => (
    <div className="flex justify-center items-center py-5">
      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"></div>
    </div>
  );

  const renderCityNotification = () => {
    if (!currentCity || isLoading) return null;
  
    return (
      <div className="text-right mb-3 text-xs text-gray-600">
         <button
          onClick={() => {
            handleCloseModal();
            const citySelectorButton = document.querySelector(
              '[data-testid="citySelectorButton"]'
            );
            if (citySelectorButton) {
              citySelectorButton.click();
            }
          }}
          className="text-blue-600 hover:text-blue-800 font-medium"
        >
          (تغییر شهر)
        </button>
        <span> شما در حال جستجو  شهر </span>
        <span className="font-medium text-gray-800">{currentCity.title}</span>
        <span> هستید. </span>
       
      </div>
    );
  };

  const renderTabContent = () => {
    switch (activeTab) {
      case "buySell":
        return (
          <div className="flex-1 py-2">
            {loading ? (
              renderSpinner()
            ) : (
              <div className="space-y-4">
                {properties.map((item) => (
                  <div
                    key={item.id}
                    className="bg-white rounded-lg p-4 shadow-sm border border-gray-200"
                  >
                    <a onClick={() => sendToCat(item)}>
                    <div className="flex flex-row-reverse items-center justify-between pb-3 border-b border-gray-100">
                      <div className="text-blue-800 font-bold text-sm">
                        {item.category} در {currentCity.title}
                        <span className="text-gray-500 text-sm">
                          {` (${Object.values(item.propertyCounts).reduce(
                            (sum, count) => sum + count,
                            0
                          )} مورد)`}
                        </span>
                      </div>
                      <button
                        className="flex flex-row-reverse items-center text-blue-600 hover:text-blue-800"
                        onClick={() => sendToCat(item)}
                      >
                        <span className="text-sm ml-1">همه موارد</span>
                        <span>‹</span>
                      </button>
                    </div>
                    </a>
  
                    <div className="flex flex-row-reverse flex-wrap gap-2 mt-3">
                      {(showAllNeighborhoods
                        ? item.neighborhoods
                        : item.neighborhoods.slice(0, 10)
                      ).map((neighborhood, index) => {
                        const propertyCount = neighborhood.property_count || 0;
                        return (
                          <button
                            key={`${item.id}-${neighborhood.name}-${index}`}
                            className={`px-3 py-1 rounded-full text-sm border bg-green-50 text-gray-700 border-green-200 hover:bg-green-100`}
                            onClick={() =>
                              // propertyCount > 0 &&
                              sendToCat(item, neighborhood.name)
                            }
                          >
                            {neighborhood.name}
                            <span className="text-gray-500 text-xs mr-1">
                              {` (${propertyCount} ملک)`}
                            </span>
                          </button>
                        );
                      })}
                    </div>
  
                    {item.neighborhoods.length > 10 &&
                      !showAllNeighborhoods && (
                        <button
                          className="w-full py-2 text-center text-blue-600 hover:text-blue-800 text-sm mt-2"
                          onClick={() => setShowAllNeighborhoods(true)}
                        >
                          نمایش همه محلات ({item.neighborhoods.length - 10} مورد
                          دیگر)
                        </button>
                      )}
                  </div>
                ))}
  
                {properties.length === 0 && !loading && (
                  <div className="text-center space-y-4">
                    {/* City notification component */}
                  {/* {renderCityNotification()} */}
                  {searchHistory.length > 0 && (
  <div className="text-right">
    {/* Title and city notification in one line */}
    <div className="flex flex-row-reverse items-center justify-between mb-2">
      <h3 className="text-gray-500 text-sm">جستجوهای اخیر:</h3>
      <div className="text-xs text-gray-600 flex flex-row-reverse items-center">
        <span className="ml-0">شما در حال جستجو در شهر </span>
        <span className="font-medium text-gray-800 mx-1">{currentCity.title}</span>
        <span>هستید</span>
        <button
          onClick={() => {
            handleCloseModal();
            const citySelectorButton = document.querySelector(
              '[data-testid="citySelectorButton"]'
            );
            if (citySelectorButton) {
              citySelectorButton.click();
            }
          }}
          className="text-blue-600 hover:text-blue-800 font-medium mr-1"
        >
          (تغییر)
        </button>
      </div>
    </div>
    
    {/* Rest of search history items */}
    <div className="flex flex-row-reverse flex-wrap gap-2 justify-end">
      {searchHistory.map((historyItem, index) => (
        <div
          key={`history-${index}`}
          className="flex flex-row-reverse items-center bg-gray-200 px-3 py-1 rounded-full cursor-pointer hover:bg-gray-300"
          onClick={() => handleHintPress(historyItem)}
        >
          <span className="text-gray-700 text-sm ml-2">
            {historyItem}
          </span>
          <button
            className="text-gray-500 hover:text-gray-700 text-xs"
            onClick={(e) => {
              e.stopPropagation();
              const updatedHistory = searchHistory.filter(
                (_, i) => i !== index
              );
              setSearchHistory(updatedHistory);
              localStorage.setItem(
                "realEstateSearchHistory",
                JSON.stringify(updatedHistory)
              );
            }}
          >
            ×
          </button>
        </div>
      ))}
    </div>
  </div>
)}
  
                    <div className="text-right">
                      <h3 className="text-gray-500 text-sm mb-2">
                        پیشنهادهایی برای جستجو:
                      </h3>
                      <div className="flex flex-row-reverse flex-wrap gap-2">
                        {estateHints.map((hint, index) => (
                          <button
                            key={`hint-${index}`}
                            className="bg-gray-600 text-white px-3 py-1 rounded-full text-sm hover:bg-gray-700"
                            onClick={() => handleHintPress(hint)}
                          >
                            {hint}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        );
  
      case "agents":
        return (
          <div className="flex-1">
            {loadingAgents ? (
              renderSpinner()
            ) : (
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 m-4">
                {agents.map((agent, index) => (
                  <SmallCard
                    key={index}
                    realEstate={agent}
                    profileImageKey="profile_url"
                    compact={true}
                  />
                ))}
              </div>
            )}
            {agents.length === 0 && !loadingAgents && (
              <div className="text-center text-gray-500 py-5 col-span-full">
                مشاوری یافت نشد
              </div>
            )}
          </div>
        );
  
      // Removed the "jobs" case
      default:
        return (
          <div className="flex-1 py-2">
            <div className="text-center text-gray-500 py-5">
              لطفاً یک تب را انتخاب کنید
            </div>
          </div>
        );
    }
  };

  return (
    <div className="w-full py-2 px-3 bg-white">
      {/* Header with Logo and Search Bar */}
      <div className="flex items-center gap-4">
        {/* Search Bar taking remaining space */}
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <CitySelector
              handleCitySelect={(city) => {
                setShowAllNeighborhoods(false);
              }}
            />

            <div
              className="flex-1 flex flex-row-reverse items-center bg-gray-50 rounded-2xl border border-gray-300 h-14 px-4 cursor-pointer shadow-sm hover:shadow-md transition-shadow relative overflow-hidden"
              onClick={() => set_modal_active(true)}
            >
              {/* Animated Suggestion Container */}
              <div className="flex-1 text-right overflow-hidden relative h-6">
                {/* Current Suggestion */}
                <div
                  className={`absolute inset-0 flex items-center transition-all duration-500 ease-in-out ${
                    suggestionDirection === "up"
                      ? "transform -translate-y-full opacity-0"
                      : "transform translate-y-0 opacity-100"
                  }`}
                >
                  <span className="text-gray-600 text-base overflow-hidden whitespace-nowrap overflow-ellipsis w-full">
                    {getCurrentSuggestion()}
                  </span>
                </div>

                {/* Next Suggestion */}
                <div
                  className={`absolute inset-0 flex items-center transition-all duration-500 ease-in-out ${
                    suggestionDirection === "up"
                      ? "transform translate-y-0 opacity-100"
                      : "transform translate-y-full opacity-0"
                  }`}
                >
                  <span className="text-gray-600 text-base overflow-hidden whitespace-nowrap overflow-ellipsis w-full">
                    {getNextSuggestion()}
                  </span>
                </div>
              </div>

              <button
                className="w-10 h-10 rounded-xl flex items-center justify-center mr-2 hover:bg-gray-200 transition-colors"
                onClick={() => set_modal_active(true)}
                aria-label="جستجو"
              >
                <SearchIcon style={{ fontSize: 22 }} />
              </button>
            </div>

            <button
              onClick={handleHomeClick}
              className="flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity"
              aria-label="رفتن به صفحه اصلی"
            >
              <img
                src="/logo/web-logo-text.png"
                alt="آجر"
                className="h-8 w-auto"
              />
            </button>
          </div>
        </div>
        {renderSnackBar()}
      </div>

      {/* Modal */}
      {showModal && (
  <div className="fixed inset-0 z-50">
    <div
      className="absolute inset-0 bg-black bg-opacity-50"
      onClick={handleCloseModal}
    />
    {/* Top-down panel: appears from above and replaces the searchbar */}
    <div
      className={`absolute top-0 left-0 right-0 bg-white rounded-b-3xl p-6 max-h-[90vh] overflow-auto flex flex-col animate__animated animate__slideInDown`}
    >
      {/* Floating close button in the corner */}
      <button
        onClick={handleCloseModal}
        aria-label="بستن"
        style={{
          position: "absolute",
          top: 16,
          right: 16,
          zIndex: 80,
          background: "transparent",
          border: "none",
          fontSize: "1.35rem",
          cursor: "pointer",
          padding: 6,
          lineHeight: 1,
        }}
      >
        ✕
      </button>

      {/* Tab Header with CitySelector */}
      <div className="flex flex-row-reverse items-center mb-4 gap-3">
        {/* Tabs Container - takes remaining space */}
        <div className="flex-1 flex justify-between gap-3">
          {Object.entries(suggestionsMap)
            .filter(([tabId]) => tabId !== "jobs") // Remove jobs tab
            .map(([tabId]) => (
              <button
                key={tabId}
                className={`flex-1 py-3 px-3 rounded-xl text-sm font-medium transition-colors ${
                  activeTab === tabId
                    ? "bg-red-500 text-white"
                    : "bg-gray-100 text-gray-500 hover:bg-gray-200"
                }`}
                onClick={() => handleTabPress(tabId)}
              >
                {tabId === "buySell" ? "املاک" : "مشاورین"}
              </button>
            ))}
        </div>
        
        {/* CitySelector placed to the left of tabs */}
        <div className="flex-shrink-0">
          <CitySelector
            handleCitySelect={(city) => {
              // When city is changed in modal, refresh the search if needed
              setShowAllNeighborhoods(false);
              if (searchQuery) {
                handleSearch(true);
              }
            }}
          />
        </div>
      </div>

      {/* Search Input */}
      <div className="flex flex-row-reverse items-center bg-white border-2 border-red-500 rounded-2xl h-14 mb-6 px-4">
        <input
          ref={inputRef}
          type="text"
          className="flex-1 h-full text-right text-gray-800 text-base outline-none px-3 bg-white"
          style={{ backgroundColor: "white" }}
          placeholder={getCurrentSuggestion()}
          value={searchQuery}
          onChange={(e) => handleTextChange(e.target.value)}
          onKeyPress={(e) => e.key === "Enter" && handleSearch(true)}
          autoFocus={isInputReady}
        />
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto">{renderTabContent()}</div>
    </div>
  </div>
)}

      {/* Fullscreen Loading Overlay - Only during redirect */}
      {isRedirecting && (
        <div className="fixed inset-0 bg-white bg-opacity-98 flex items-center justify-center z-[9999]">
          <img
            className="spinner-image"
            src="/logo/ajour-gif.gif"
            alt="در حال رفتن به نتایج"
            style={{
              width: "150px",
              height: "150px",
            }}
          />
        </div>
      )}
    </div>
  );
};

export default SearchBars;



import React, { useState, useRef, useEffect, useContext } from "react";
import axios from "axios";
import { CityContext } from "./CityContext";
import CitySelector from "./CitySelector";
import SearchIcon from "@mui/icons-material/Search";
import { useRouter } from "next/router";
import SmallCard from "../cards/SmallCard";
import { Snackbar, Alert } from "@mui/material";

const RealEstateCard = ({ realstate, circle_size }) => (
  <div className="bg-white p-4 rounded-lg shadow-md border border-gray-200">
    نمایش کارت املاک
  </div>
);

const suggestionsMap = {
  buySell: [
    "مثلا : خرید خانه ",
    "مثلا : ویلایی ",
    "مثلا تجاری ",
    "مثلا : اجاره آپارتمان",
  ],
  agents: [
    "جستجو مشاور : مثلا محمد دهقان",
    "جستجو مشاور املاک...",
    "مشاور املاک متخصص...",
  ],
  jobs: [
    "مثلا : نقاش ساختمان",
    "دکوراسیون داخلی",
    "مثلا : بنا",
    "مثلا : گچ کار",
  ],
};

const estateHints = [
  "آپارتمان",
  "خانه ویلایی",
  "زمین مسکونی",
  "مغازه",
  "اجاره آپارتمان",
  "اجاره خانه ویلایی",
  "باغ و باغچه",
  "زمین صنعتی",
];

const SEARCH_TIMEOUT = 15000;
const TYPING_DELAY = 600;

const categoriesData = [
  {
    id: 3,
    name: "خرید صنعتی",
    description: null,
    status: "1",
    has_parent: "0",
    has_child: "0",
    parent_id: "0",
    sort_order: "1",
    avatar: "industry",
    created_at: "2021-01-03T21:56:25.000000Z",
    updated_at: "2021-01-03T21:56:25.000000Z",
    type: "sell",
  },
  {
    id: 6,
    name: "اجاره صنعتی",
    description: "اجاره انواع واحد های صنعتی",
    status: "1",
    has_parent: "0",
    has_child: "0",
    parent_id: "0",
    sort_order: "27",
    avatar: "rent_industrial",
    created_at: "2024-04-06T16:01:02.000000Z",
    updated_at: "2024-04-06T16:01:02.000000Z",
    type: "rent",
  },
  {
    id: 16,
    name: "خرید آپارتمان",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "1",
    sort_order: "16",
    avatar: "sell_apartment",
    created_at: null,
    updated_at: null,
    type: "sell",
  },
  {
    id: 17,
    name: "خرید خانه ویلایی",
    description: "فروش انواع خانه های ویلایی",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "1",
    sort_order: "17",
    avatar: "sell_industrial_land",
    created_at: "2024-04-06T15:18:54.000000Z",
    updated_at: "2024-04-06T15:18:54.000000Z",
    type: "sell",
  },
  {
    id: 18,
    name: "خرید زمین مسکونی",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "18",
    avatar: "sell_residental_land",
    created_at: "2021-01-03T21:56:25.000000Z",
    updated_at: "2021-01-03T21:56:25.000000Z",
    type: "sell",
  },
  {
    id: 19,
    name: "خرید زمین تجاری و اداری",
    description: "دسته بندی زمین های تجاری و اداری",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "19",
    avatar: "sell_office_land",
    created_at: "2024-04-06T15:11:50.000000Z",
    updated_at: "2024-04-06T15:11:50.000000Z",
    type: "sell",
  },
  {
    id: 20,
    name: "خرید زمین صنعتی ",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "20",
    avatar: "sell_industrial_land",
    created_at: "2024-04-06T15:13:10.000000Z",
    updated_at: "2024-04-06T15:13:10.000000Z",
    type: "sell",
  },
  {
    id: 21,
    name: "خرید باغ و باغچه",
    description: "فروش انواع باغ و باغچه",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "21",
    avatar: "sell_industrial",
    created_at: "2024-04-06T15:54:38.000000Z",
    updated_at: "2024-04-06T15:54:38.000000Z",
    type: "sell",
  },
  {
    id: 22,
    name: "خرید زمین زراعی\n",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "22",
    avatar: "sell_farm_land",
    created_at: "2024-04-06T15:15:48.000000Z",
    updated_at: "2024-04-06T15:15:48.000000Z",
    type: "sell",
  },
  {
    id: 23,
    name: "خرید مغازه\n",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "4",
    sort_order: "23",
    avatar: "sell_store",
    created_at: "2024-04-06T15:48:19.000000Z",
    updated_at: "2024-04-06T15:48:19.000000Z",
    type: "sell",
  },
  {
    id: 24,
    name: "خرید دفتر کار و اداری",
    description: "انواع دفتر کار ، سالن و اداری",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "4",
    sort_order: "24",
    avatar: "sell_office",
    created_at: "2024-04-06T15:50:53.000000Z",
    updated_at: "2024-04-06T15:50:53.000000Z",
    type: "sell",
  },
  {
    id: 25,
    name: "اجاره آپارتمان",
    description: "اجاره انواع آپارتمان",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "5",
    sort_order: "25",
    avatar: "rent_apartment",
    created_at: "2024-04-06T15:59:02.000000Z",
    updated_at: "2024-04-06T15:59:02.000000Z",
    type: "rent",
  },
  {
    id: 26,
    name: "اجاره خانه ویلایی",
    description: "اجاره انواع خانه های ویلایی",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "5",
    sort_order: "26",
    avatar: "rent_villa",
    created_at: "2024-04-06T15:56:47.000000Z",
    updated_at: "2024-04-06T15:56:47.000000Z",
    type: "rent",
  },
  {
    id: 27,
    name: "اجاره مغازه",
    description: "اجاره انواع مغازه",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "7",
    sort_order: "27",
    avatar: "sell_store",
    created_at: "2024-04-06T16:08:35.000000Z",
    updated_at: "2024-04-06T16:08:35.000000Z",
    type: "rent",
  },
  {
    id: 28,
    name: "اجاره دفتر کار و اداری",
    description: "اجاره انواع دفتر کار، مطب و واحد اداری",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "7",
    sort_order: "28",
    avatar: "rent_office",
    created_at: "2024-04-06T16:09:35.000000Z",
    updated_at: "2024-04-06T16:09:35.000000Z",
    type: "rent",
  },
  {
    id: 65,
    name: "زمین هکتاری",
    description: "زمین هکتاری",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "1",
    avatar: "hectare_land",
    created_at: "2025-02-12T18:19:41.000000Z",
    updated_at: "2025-02-12T18:19:41.000000Z",
    type: "sell",
  },
];

const SearchBars = ({ realstates }) => {
  const router = useRouter();
  const { currentCity, isLoading } = useContext(CityContext);
  // State management
  const [activeTab, setActiveTab] = useState("buySell");
  const [searchQuery, setSearchQuery] = useState("");
  const [properties, setProperties] = useState([]);
  const [agents, setAgents] = useState([]);
  const [loading, setLoading] = useState(false);
  const [loadingAgents, setLoadingAgents] = useState(false);
  const [isRedirecting, setIsRedirecting] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [currentSuggestionIndex, setCurrentSuggestionIndex] = useState(0);
  const [isInputReady, setIsInputReady] = useState(false);
  const [searchStatus, setSearchStatus] = useState("جستجو...");
  const [networkStatus, setNetworkStatus] = useState({
    isConnected: true,
    isInternetReachable: true,
  });
  const [selectedCityName, setSelectedCityName] = useState();
  const [selectedCityId, setSelectedCityId] = useState();
  const [showCityModal, setShowCityModal] = useState(false);
  const [search_category, set_search_category] = useState([]);
  const [search_neighborhoods, set_search_neighborhoods] = useState([]);
  const [searchHistory, setSearchHistory] = useState([]);
  const [showAllNeighborhoods, setShowAllNeighborhoods] = useState(false);
  const [lastHintPressed, setLastHintPressed] = useState(null);
  const [suggestionDirection, setSuggestionDirection] = useState("down");
  const [snackOpen, setSnackOpen] = useState(false);
  const [snack, setSnack] = useState("");

  // Refs
  const inputRef = useRef(null);
  const suggestionIntervalRef = useRef(null);
  const loadingTimeoutRef = useRef(null);
  const progressIntervalRef = useRef(null);
  const typingTimeoutRef = useRef(null);

  const [cities, setCities] = useState([]);

  const getDefaultCities = () => [
    { id: 1, title: "تهران" },
    { id: 2, title: "رباط کریم" },
    { id: 3, title: "کرج" },
    { id: 4, title: "اصفهان" },
    { id: 5, title: "مشهد" },
  ];

  // Helper function to calculate string similarity
  const calculateSimilarity = (str1, str2) => {
    if (!str1 || !str2) return 0;
    
    const cleanStr1 = str1.replace(/\s+/g, '').toLowerCase();
    const cleanStr2 = str2.replace(/\s+/g, '').toLowerCase();
    
    if (cleanStr1.includes(cleanStr2) || cleanStr2.includes(cleanStr1)) {
      return 1;
    }
    
    const set1 = new Set(cleanStr1.split(''));
    const set2 = new Set(cleanStr2.split(''));
    
    const intersection = new Set([...set1].filter(x => set2.has(x)));
    const union = new Set([...set1, ...set2]);
    
    return union.size > 0 ? intersection.size / union.size : 0;
  };

  // Helper function to extract main category from search query
  const extractMainCategory = (searchQuery) => {
    if (!searchQuery || typeof searchQuery !== 'string') return '';
    
    // Clean the query - remove common extra details
    const cleanQuery = searchQuery
      .replace(/در\s+[\u0600-\u06FF\uFB8A\u067E\u0686\u06AF\s]+$/g, '') // Remove location at the end
      .replace(/\s+دو\s+خوابه/gi, '')
      .replace(/\s+سه\s+خوابه/gi, '')
      .replace(/\s+چهار\s+خوابه/gi, '')
      .replace(/\s+نوساز/gi, '')
      .replace(/\s+نو\s+ساز/gi, '')
      .replace(/\s+نو/gi, '')
      .replace(/\s+قدیمی/gi, '')
      .replace(/\s+تازه\s+ساز/gi, '')
      .replace(/\s+نوسازی/gi, '')
      .replace(/\s+متراژ\s+\d+/gi, '')
      .replace(/\s+\d+\s+متری/gi, '')
      .replace(/\s+تخفیف\s+دارد/gi, '')
      .replace(/\s+ویژه/gi, '')
      .replace(/\s+عالی/gi, '')
      .replace(/\s+خوب/gi, '')
      .replace(/\s+مناسب/gi, '')
      .replace(/\s+ارزان/gi, '')
      .replace(/\s+گران/gi, '')
      .replace(/\s+لوکس/gi, '')
      .replace(/\s+مدرن/gi, '')
      .replace(/\s+شیک/gi, '')
      .trim();
    
    // Try to find exact match first
    const exactMatch = categoriesData.find(cat => 
      cleanQuery.includes(cat.name) || cat.name.includes(cleanQuery)
    );
    
    if (exactMatch) {
      return exactMatch.name;
    }
    
    // Try to match with keyword patterns
    const queryWords = cleanQuery.split(' ').filter(word => word.length > 2);
    
    // Look for category keywords in query
    for (const category of categoriesData) {
      const categoryWords = category.name.split(' ').filter(word => word.length > 2);
      
      // Check if any category word appears in query
      const hasMatch = categoryWords.some(catWord => 
        queryWords.some(qWord => qWord.includes(catWord) || catWord.includes(qWord))
      );
      
      if (hasMatch) {
        return category.name;
      }
    }
    
    // Try partial matching based on first words
    if (queryWords.length >= 2) {
      const firstTwoWords = queryWords.slice(0, 2).join(' ');
      const matchedCategory = categoriesData.find(cat => 
        cat.name.includes(firstTwoWords) || calculateSimilarity(cat.name, firstTwoWords) > 0.7
      );
      
      if (matchedCategory) {
        return matchedCategory.name;
      }
    }
    
    // Return cleaned query as fallback
    return cleanQuery;
  };

  // Updated findCategoryByName with fuzzy matching
  const findCategoryByName = (categoryName) => {
    if (!categoryName || typeof categoryName !== 'string') {
      return null;
    }
    
    const normalizedInput = categoryName.replace(/\s+/g, " ").trim().toLowerCase();
    
    // 1. Try exact match
    const exactMatch = categoriesData.find(cat => 
      cat.name.toLowerCase() === normalizedInput
    );
    if (exactMatch) return exactMatch;
    
    // 2. Try extraction first
    const extractedCategory = extractMainCategory(categoryName);
    if (extractedCategory && extractedCategory !== categoryName) {
      const match = categoriesData.find(cat => 
        cat.name.toLowerCase() === extractedCategory.toLowerCase()
      );
      if (match) return match;
    }
    
    // 3. Try partial match with high similarity
    for (const category of categoriesData) {
      const normalizedCatName = category.name.toLowerCase();
      
      // Check if category is contained in search query
      if (normalizedInput.includes(normalizedCatName)) {
        return category;
      }
      
      // Check if search query is contained in category
      if (normalizedCatName.includes(normalizedInput) && normalizedInput.length > 3) {
        return category;
      }
      
      // Calculate similarity
      const similarity = calculateSimilarity(normalizedInput, normalizedCatName);
      if (similarity > 0.5) {
        return category;
      }
    }
    
    // 4. Try word-by-word matching
    const inputWords = normalizedInput.split(' ').filter(word => word.length > 2);
    
    for (const category of categoriesData) {
      const catWords = category.name.toLowerCase().split(' ').filter(word => word.length > 2);
      
      // Count matching words
      const matchingWords = inputWords.filter(inputWord => 
        catWords.some(catWord => 
          catWord.includes(inputWord) || inputWord.includes(catWord)
        )
      );
      
      // If at least 2 words match or 50% of words match
      if (matchingWords.length >= 2 || 
          (inputWords.length > 0 && matchingWords.length / inputWords.length >= 0.5)) {
        return category;
      }
    }
    
    // 5. Try to match main keywords
    const mainKeywords = ["خرید", "اجاره", "آپارتمان", "خانه", "ویلایی", "زمین", "مغازه", "دفتر", "صنعتی", "باغ"];
    const hasMainKeyword = mainKeywords.some(keyword => normalizedInput.includes(keyword));
    
    if (hasMainKeyword) {
      // Find the most relevant category based on keywords
      let bestMatch = null;
      let highestScore = 0;
      
      for (const category of categoriesData) {
        let score = 0;
        const catName = category.name.toLowerCase();
        
        // Score based on keyword matches
        mainKeywords.forEach(keyword => {
          if (normalizedInput.includes(keyword) && catName.includes(keyword)) {
            score += 2;
          }
        });
        
        // Bonus for transaction type match (خرید/اجاره)
        if ((normalizedInput.includes("خرید") && catName.includes("خرید")) ||
            (normalizedInput.includes("اجاره") && catName.includes("اجاره"))) {
          score += 3;
        }
        
        if (score > highestScore) {
          highestScore = score;
          bestMatch = category;
        }
      }
      
      if (bestMatch && highestScore >= 2) {
        return bestMatch;
      }
    }
    
    return null;
  };

  // Effects
  useEffect(() => {
    if (currentCity && !isLoading) {
      // fetchData(currentCity.id);
    }
  }, [currentCity, isLoading]);

  useEffect(() => {
    // Reset redirecting spinner when route changes complete
    const handleRouteChangeComplete = () => {
      setIsRedirecting(false);
    };

    router.events.on("routeChangeComplete", handleRouteChangeComplete);
    return () => {
      router.events.off("routeChangeComplete", handleRouteChangeComplete);
    };
  }, [router]);

  useEffect(() => {
    if (lastHintPressed) {
      handleSearch(true);
    }
  }, [lastHintPressed]);

  useEffect(() => {
    const loadSearchHistory = async () => {
      try {
        const history = localStorage.getItem("realEstateSearchHistory");
        if (history) {
          setSearchHistory(JSON.parse(history));
        }
      } catch (error) {
        console.error("Failed to load search history", error);
      }
    };
    loadSearchHistory();
  }, []);

  useEffect(() => {
    if (activeTab && !searchQuery && !showModal) {
      suggestionIntervalRef.current = setInterval(() => {
        setSuggestionDirection("up");

        setTimeout(() => {
          setCurrentSuggestionIndex((prev) =>
            prev >= suggestionsMap[activeTab].length - 1 ? 0 : prev + 1
          );

          setTimeout(() => {
            setSuggestionDirection("down");
          }, 100);
        }, 500);
      }, 3000);
    } else {
      clearInterval(suggestionIntervalRef.current);
      setCurrentSuggestionIndex(0);
      setSuggestionDirection("down");
    }
    return () => clearInterval(suggestionIntervalRef.current);
  }, [activeTab, searchQuery, showModal]);

  useEffect(() => {
    if (showModal) {
      const timer = setTimeout(() => {
        setIsInputReady(true);
        inputRef.current?.focus();
      }, 300);
      return () => clearTimeout(timer);
    } else {
      setIsInputReady(false);
    }
  }, [showModal]);

  // Helper functions
  const handleSnackbar = (message) => {
    setSnack(message);
    setSnackOpen(true);
  };

  const renderSnackBar = () => {
    return (
      <Snackbar
        open={snackOpen}
        autoHideDuration={4000}
        onClose={() => setSnackOpen(false)}
        anchorOrigin={{ vertical: "top", horizontal: "center" }}
        sx={{
          "& .MuiSnackbarContent-root": {
            fontSize: "1.2rem", // Larger font
            padding: "16px 24px", // More padding
            minWidth: "400px", // Minimum width
          },
        }}
      >
        <Alert
          onClose={() => setSnackOpen(false)}
          severity="warning"
          sx={{ width: "100%" }}
        >
          {snack}
        </Alert>
      </Snackbar>
    );
  };

  const fetch_cities_from_data_base = async () =>  {
    try {
      const response = await axios.get(
        "https://api.ajur.app/api/search-cities",
        {
          params: { title: '' || "" },
          timeout: 5000,
        }
      );
      setCities(response.data?.items || getDefaultCities());
      console.log("now cities:", response.data?.items);
    } catch (error) {
      console.error("Error fetching cities:", error);
      setCities(getDefaultCities());
    }
  }

  const getCurrentSuggestion = () => {
    if (searchQuery) return searchQuery;
    if (!activeTab) return "جستجو...";
    return suggestionsMap[activeTab][currentSuggestionIndex] || "جستجو...";
  };

  const getNextSuggestion = () => {
    if (!activeTab) return "جستجو...";
    const nextIndex =
      currentSuggestionIndex >= suggestionsMap[activeTab].length - 1
        ? 0
        : currentSuggestionIndex + 1;
    return suggestionsMap[activeTab][nextIndex] || "جستجو...";
  };

  const saveToHistory = async (query) => {
    if (!query.trim()) return;
    try {
      const updatedHistory = [
        query,
        ...searchHistory.filter(
          (item) => item.toLowerCase() !== query.toLowerCase()
        ),
      ].slice(0, 10);
      setSearchHistory(updatedHistory);
      localStorage.setItem(
        "realEstateSearchHistory",
        JSON.stringify(updatedHistory)
      );
    } catch (error) {
      console.error("Failed to save search history", error);
    }
  };

  const handleTabPress = (tabId) => {
    if (tabId === "agents") {
      if (!currentCity || isLoading) {
        setSearchStatus("لطفاً ابتدا یک شهر را انتخاب کنید");
        return;
      }
      getAgentsCall("all", currentCity.id);
    }
    setActiveTab(tabId);
    setSearchQuery("");
    setSearchStatus("جستجو...");
  };

  const handleCloseModal = () => {
    setActiveTab("buySell");
    setShowModal(false);
    setIsRedirecting(false);
    clearTimeout(loadingTimeoutRef.current);
    clearInterval(progressIntervalRef.current);
  };

  const handleHintPress = (hint) => {
    setSearchQuery(hint);
    setLastHintPressed(hint);
    handleSearch(true);
  };

  const handleTextChange = (text) => {
    setSearchQuery(text);
    if (typingTimeoutRef.current) {
      clearTimeout(typingTimeoutRef.current);
    }
    if (text.trim().length > 0) {
      typingTimeoutRef.current = setTimeout(() => {
        handleSearch(false);
      }, TYPING_DELAY);
    }
  };

  const getAgentsCall = async (searchTerm) => {
    try {
      setLoadingAgents(true);
      setSearchStatus("در حال جستجوی مشاورین...");
      const response = await axios.get(
        "https://api.ajur.app/api/agents-search",
        {
          params: { title: searchTerm, limit: 20, city: currentCity.id },
          timeout: SEARCH_TIMEOUT,
        }
      );
      setAgents(response.data.agents || []);
      setSearchStatus(`${response.data.agents.length} مشاور یافت شد`);
    } catch (error) {
      console.error("Agent search failed:", error);
      setSearchStatus("خطا در جستجوی مشاورین");
    } finally {
      setLoadingAgents(false);
    }
  };

  const sendToCat = (item, neighborhoodName = null) => {
    console.log("Item data:", item);
    console.log("Original search query:", searchQuery);

    handleCloseModal();

    let categoryId;
    let categoryName;

    // First try to match with item data
    if (item.category_array && typeof item.category_array === "object") {
      categoryId = item.category_array.id;
      categoryName = item.category_array.name || item.category;
    } else if (
      Array.isArray(item.category_array) &&
      item.category_array.length > 0
    ) {
      const firstCategory = item.category_array[0];
      if (typeof firstCategory === "object") {
        categoryId = firstCategory.id;
        categoryName = firstCategory.name || item.category;
      } else {
        categoryId = firstCategory;
        categoryName = item.category;
      }
    } else {
      // Try fuzzy matching with the original search query
      console.log("Attempting fuzzy matching for:", searchQuery);
      const matchedCategory = findCategoryByName(searchQuery);
      
      if (matchedCategory) {
        console.log("Matched category via fuzzy search:", matchedCategory);
        categoryId = matchedCategory.id;
        categoryName = matchedCategory.name;
      } else if (item.category) {
        // Try with the item's category name
        console.log("Trying with item category:", item.category);
        const categoryFromItem = findCategoryByName(item.category);
        if (categoryFromItem) {
          categoryId = categoryFromItem.id;
          categoryName = categoryFromItem.name;
        } else {
          console.error("No category found for item:", item);
          handleSnackbar("دسته‌بندی‌ای برای این جستجو یافت نشد");
          return;
        }
      } else {
        console.error("No category found for item:", item);
        handleSnackbar("دسته‌بندی‌ای برای این جستجو یافت نشد");
        return;
      }
    }

    const queryParams = {
      name: categoryName,
      id: categoryId,
      categories: categoryId,
      original_query: searchQuery, // Pass original query as parameter
    };

    if (neighborhoodName) {
      queryParams.neighbor = neighborhoodName;
    }

    if (currentCity) {
      queryParams.city = currentCity.title;
    }

    console.log("Navigating to category page with params:", queryParams);

    const dynamicPathname = `/${currentCity.title}/${encodeURIComponent(
      categoryName
    )}`;

    // Show spinner during redirect
    setIsRedirecting(true);

    router.push({
      pathname: dynamicPathname,
      query: queryParams,
    });
  };

  const handleSearch = async (isManualSearch = true) => {
    if (!currentCity || isLoading) {
      setSearchStatus("لطفاً ابتدا یک شهر را انتخاب کنید");
      return;
    }
    if (!searchQuery.trim()) {
      return;
    }

    console.log(`Searching for "${searchQuery}" in ${activeTab} tab`);

    try {
      setLoading(true);
      setSearchStatus("در حال جستجو...");

      if (isManualSearch) {
        await saveToHistory(searchQuery);
      }

      progressIntervalRef.current = setInterval(() => {
        setSearchStatus((prev) =>
          prev.includes("...") ? "در حال جستجو" : prev + "."
        );
      }, 500);

      switch (activeTab) {
        case "buySell":
          try {
            // Extract main category for better matching
            const mainCategory = extractMainCategory(searchQuery);
            console.log("Extracted main category:", mainCategory);
            
            const response = await axios.post(
              "https://api.ajur.app/api/search-intent",
              {
                query: mainCategory,
                original_query: searchQuery,
                cityid: currentCity.id,
                fuzzy_match: true,
              },
              { timeout: 10000 }
            );

            clearTimeout(loadingTimeoutRef.current);
            clearInterval(progressIntervalRef.current);

            if (!response.data || !Array.isArray(response.data)) {
              throw new Error("پاسخ نامعتبر از سرور دریافت شد");
            }

            const categoriesWithNeighborhoods = response.data;
            const allNeighborhoods =
              categoriesWithNeighborhoods.length > 0
                ? [
                    ...new Set(
                      categoriesWithNeighborhoods.flatMap((c) =>
                        c.neighborhoods.map((n) => n.name)
                      )
                    ),
                  ]
                : [];

            set_search_neighborhoods(allNeighborhoods);

            const displayItems = categoriesWithNeighborhoods.map(
              (categoryData, index) => {
                const categoryName = categoryData.category_name;
                const category_array = categoryData.category;
                const neighborhoods = categoryData.neighborhoods;

                return {
                  id: `category-${index}-${Date.now()}`,
                  category: categoryName,
                  category_array: category_array,
                  neighborhoods: neighborhoods,
                  propertyCounts: neighborhoods.reduce((acc, curr) => {
                    acc[curr.name] = curr.property_count;
                    return acc;
                  }, {}),
                  filters: { category_name: categoryName },
                  chips: neighborhoods
                    .filter((n) => n.property_count > 0)
                    .slice(0, 5)
                    .map((n) => ({
                      label: `${n.name} (${n.property_count})`,
                      value: n.name,
                    })),
                  isEmpty: neighborhoods.every((n) => n.property_count === 0),
                  isPrimary: index === 0,
                };
              }
            );

            if (displayItems.length === 0) {
              // Try to create a fallback category based on search query
              const matchedCategory = findCategoryByName(searchQuery);
              if (matchedCategory) {
                displayItems.push({
                  id: "fallback-category",
                  category: matchedCategory.name,
                  category_array: matchedCategory,
                  neighborhoods: [],
                  propertyCounts: {},
                  filters: { category_name: matchedCategory.name },
                  chips: [],
                  isEmpty: true,
                  isPrimary: true,
                });
              } else {
                displayItems.push({
                  id: "default-category",
                  category: "",
                  neighborhoods: [],
                  propertyCounts: {},
                  filters: {},
                  chips: [],
                  isEmpty: true,
                  isPrimary: true,
                });
              }
            }

            setProperties(displayItems);

            const statusText =
              categoriesWithNeighborhoods.length > 0
                ? `دسته‌بندی‌ها: ${categoriesWithNeighborhoods
                    .map((c) => c.category_name)
                    .join("، ")} در ${currentCity.title}`
                : `جستجوی "${searchQuery}" در ${currentCity.title}`;

            setSearchStatus(statusText);
          } catch (error) {
            console.error("Search error:", error);
            setSearchStatus("خطایی در دریافت اطلاعات رخ داده است");
          }
          break;

        case "agents":
          await getAgentsCall(searchQuery);
          break;

        case "jobs":
          setSearchStatus("جستجوی مشاغل انجام شد");
          break;

        default:
          setSearchStatus("لطفاً یک تب معتبر را انتخاب کنید");
          return;
      }
    } catch (error) {
      console.error("Search error:", error);
      clearTimeout(loadingTimeoutRef.current);
      clearInterval(progressIntervalRef.current);
      setSearchStatus("خطا در جستجو");
    } finally {
      setLoading(false);
    }
  };

  const set_modal_active = (status) => {
    if (!currentCity || isLoading) {
      handleSnackbar("لطفاً ابتدا یک شهر را انتخاب کنید");
      // Trigger the CitySelector modal to open
      const citySelectorButton = document.querySelector(
        '[data-testid="citySelectorButton"]'
      );
      if (citySelectorButton) {
        citySelectorButton.click();
      }
      return;
    }
    setShowAllNeighborhoods(false);
    setProperties([]);
    setSearchQuery("");
    setShowModal(true);

    const timer = setTimeout(() => {
      setIsInputReady(true);
      inputRef.current?.focus();
    }, 500);
    return () => clearTimeout(timer);
  };

  const handleHomeClick = () => {
    router.push("/");
  };

  const renderSpinner = () => (
    <div className="flex justify-center items-center py-5">
      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"></div>
    </div>
  );

  const renderTabContent = () => {
    switch (activeTab) {
      case "buySell":
        return (
          <div className="flex-1 py-2">
            {loading ? (
              renderSpinner()
            ) : (
              <div className="space-y-4">
                {properties.map((item) => (
                  <div
                    key={item.id}
                    className="bg-white rounded-lg p-4 shadow-sm border border-gray-200"
                  >
                    <a onClick={() => sendToCat(item)}>
                    <div className="flex flex-row-reverse items-center justify-between pb-3 border-b border-gray-100">
                      <div className="text-blue-800 font-bold text-sm">
                        {item.category} در {currentCity.title}
                        <span className="text-gray-500 text-sm">
                          {` (${Object.values(item.propertyCounts).reduce(
                            (sum, count) => sum + count,
                            0
                          )} مورد)`}
                        </span>
                      </div>
                      <button
                        className="flex flex-row-reverse items-center text-blue-600 hover:text-blue-800"
                        onClick={() => sendToCat(item)}
                      >
                        <span className="text-sm ml-1">همه موارد</span>
                        <span>‹</span>
                      </button>
                    </div>
                    </a>
  
                    <div className="flex flex-row-reverse flex-wrap gap-2 mt-3">
                      {(showAllNeighborhoods
                        ? item.neighborhoods
                        : item.neighborhoods.slice(0, 10)
                      ).map((neighborhood, index) => {
                        const propertyCount = neighborhood.property_count || 0;
                        return (
                          <button
                            key={`${item.id}-${neighborhood.name}-${index}`}
                            className={`px-3 py-1 rounded-full text-sm border bg-green-50 text-gray-700 border-green-200 hover:bg-green-100`}
                            onClick={() =>
                              sendToCat(item, neighborhood.name)
                            }
                          >
                            {neighborhood.name}
                            <span className="text-gray-500 text-xs mr-1">
                              {` (${propertyCount} ملک)`}
                            </span>
                          </button>
                        );
                      })}
                    </div>
  
                    {item.neighborhoods.length > 10 &&
                      !showAllNeighborhoods && (
                        <button
                          className="w-full py-2 text-center text-blue-600 hover:text-blue-800 text-sm mt-2"
                          onClick={() => setShowAllNeighborhoods(true)}
                        >
                          نمایش همه محلات ({item.neighborhoods.length - 10} مورد
                          دیگر)
                        </button>
                      )}
                  </div>
                ))}
  
                {properties.length === 0 && !loading && (
                  <div className="text-center space-y-4">
                    {searchHistory.length > 0 && (
  <div className="text-right">
    {/* Title and city notification in one line */}
    <div className="flex flex-row-reverse items-center justify-between mb-2">
      <h3 className="text-gray-500 text-sm">جستجوهای اخیر:</h3>
      <div className="text-xs text-gray-600 flex flex-row-reverse items-center">
        <span className="ml-0">شما در حال جستجو در شهر </span>
        <span className="font-medium text-gray-800 mx-1">{currentCity.title}</span>
        <span>هستید</span>
        <button
          onClick={() => {
            handleCloseModal();
            const citySelectorButton = document.querySelector(
              '[data-testid="citySelectorButton"]'
            );
            if (citySelectorButton) {
              citySelectorButton.click();
            }
          }}
          className="text-blue-600 hover:text-blue-800 font-medium mr-1"
        >
          (تغییر)
        </button>
      </div>
    </div>
    
    {/* Rest of search history items */}
    <div className="flex flex-row-reverse flex-wrap gap-2 justify-end">
      {searchHistory.map((historyItem, index) => (
        <div
          key={`history-${index}`}
          className="flex flex-row-reverse items-center bg-gray-200 px-3 py-1 rounded-full cursor-pointer hover:bg-gray-300"
          onClick={() => handleHintPress(historyItem)}
        >
          <span className="text-gray-700 text-sm ml-2">
            {historyItem}
          </span>
          <button
            className="text-gray-500 hover:text-gray-700 text-xs"
            onClick={(e) => {
              e.stopPropagation();
              const updatedHistory = searchHistory.filter(
                (_, i) => i !== index
              );
              setSearchHistory(updatedHistory);
              localStorage.setItem(
                "realEstateSearchHistory",
                JSON.stringify(updatedHistory)
              );
            }}
          >
            ×
          </button>
        </div>
      ))}
    </div>
  </div>
)}
  
                    <div className="text-right">
                      <h3 className="text-gray-500 text-sm mb-2">
                        پیشنهادهایی برای جستجو:
                      </h3>
                      <div className="flex flex-row-reverse flex-wrap gap-2">
                        {estateHints.map((hint, index) => (
                          <button
                            key={`hint-${index}`}
                            className="bg-gray-600 text-white px-3 py-1 rounded-full text-sm hover:bg-gray-700"
                            onClick={() => handleHintPress(hint)}
                          >
                            {hint}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        );
  
      case "agents":
        return (
          <div className="flex-1">
            {loadingAgents ? (
              renderSpinner()
            ) : (
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 m-4">
                {agents.map((agent, index) => (
                  <SmallCard
                    key={index}
                    realEstate={agent}
                    profileImageKey="profile_url"
                    compact={true}
                  />
                ))}
              </div>
            )}
            {agents.length === 0 && !loadingAgents && (
              <div className="text-center text-gray-500 py-5 col-span-full">
                مشاوری یافت نشد
              </div>
            )}
          </div>
        );
  
      // Removed the "jobs" case
      default:
        return (
          <div className="flex-1 py-2">
            <div className="text-center text-gray-500 py-5">
              لطفاً یک تب را انتخاب کنید
            </div>
          </div>
        );
    }
  };

  return (
    <div className="w-full py-2 px-3 bg-white">
      {/* Header with Logo and Search Bar */}
      <div className="flex items-center gap-4">
        {/* Search Bar taking remaining space */}
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <CitySelector
              handleCitySelect={(city) => {
                setShowAllNeighborhoods(false);
              }}
            />

            <div
              className="flex-1 flex flex-row-reverse items-center bg-gray-50 rounded-2xl border border-gray-300 h-14 px-4 cursor-pointer shadow-sm hover:shadow-md transition-shadow relative overflow-hidden"
              onClick={() => set_modal_active(true)}
            >
              {/* Animated Suggestion Container */}
              <div className="flex-1 text-right overflow-hidden relative h-6">
                {/* Current Suggestion */}
                <div
                  className={`absolute inset-0 flex items-center transition-all duration-500 ease-in-out ${
                    suggestionDirection === "up"
                      ? "transform -translate-y-full opacity-0"
                      : "transform translate-y-0 opacity-100"
                  }`}
                >
                  <span className="text-gray-600 text-base overflow-hidden whitespace-nowrap overflow-ellipsis w-full">
                    {getCurrentSuggestion()}
                  </span>
                </div>

                {/* Next Suggestion */}
                <div
                  className={`absolute inset-0 flex items-center transition-all duration-500 ease-in-out ${
                    suggestionDirection === "up"
                      ? "transform translate-y-0 opacity-100"
                      : "transform translate-y-full opacity-0"
                  }`}
                >
                  <span className="text-gray-600 text-base overflow-hidden whitespace-nowrap overflow-ellipsis w-full">
                    {getNextSuggestion()}
                  </span>
                </div>
              </div>

              <button
                className="w-10 h-10 rounded-xl flex items-center justify-center mr-2 hover:bg-gray-200 transition-colors"
                onClick={() => set_modal_active(true)}
                aria-label="جستجو"
              >
                <SearchIcon style={{ fontSize: 22 }} />
              </button>
            </div>

            <button
              onClick={handleHomeClick}
              className="flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity"
              aria-label="رفتن به صفحه اصلی"
            >
              <img
                src="/logo/web-logo-text.png"
                alt="آجر"
                className="h-8 w-auto"
              />
            </button>
          </div>
        </div>
        {renderSnackBar()}
      </div>

      {/* Modal */}
      {showModal && (
  <div className="fixed inset-0 z-50">
    <div
      className="absolute inset-0 bg-black bg-opacity-50"
      onClick={handleCloseModal}
    />
    {/* Top-down panel: appears from above and replaces the searchbar */}
    <div
      className={`absolute top-0 left-0 right-0 bg-white rounded-b-3xl p-6 max-h-[90vh] overflow-auto flex flex-col animate__animated animate__slideInDown`}
    >
      {/* Floating close button in the corner */}
      <button
        onClick={handleCloseModal}
        aria-label="بستن"
        style={{
          position: "absolute",
          top: 16,
          right: 16,
          zIndex: 80,
          background: "transparent",
          border: "none",
          fontSize: "1.35rem",
          cursor: "pointer",
          padding: 6,
          lineHeight: 1,
        }}
      >
        ✕
      </button>

      {/* Tab Header with CitySelector */}
      <div className="flex flex-row-reverse items-center mb-4 gap-3">
        {/* Tabs Container - takes remaining space */}
        <div className="flex-1 flex justify-between gap-3">
          {Object.entries(suggestionsMap)
            .filter(([tabId]) => tabId !== "jobs") // Remove jobs tab
            .map(([tabId]) => (
              <button
                key={tabId}
                className={`flex-1 py-3 px-3 rounded-xl text-sm font-medium transition-colors ${
                  activeTab === tabId
                    ? "bg-red-500 text-white"
                    : "bg-gray-100 text-gray-500 hover:bg-gray-200"
                }`}
                onClick={() => handleTabPress(tabId)}
              >
                {tabId === "buySell" ? "املاک" : "مشاورین"}
              </button>
            ))}
        </div>
        
        {/* CitySelector placed to the left of tabs */}
        <div className="flex-shrink-0">
          <CitySelector
            handleCitySelect={(city) => {
              // When city is changed in modal, refresh the search if needed
              setShowAllNeighborhoods(false);
              if (searchQuery) {
                handleSearch(true);
              }
            }}
          />
        </div>
      </div>

      {/* Search Input */}
      <div className="flex flex-row-reverse items-center bg-white border-2 border-red-500 rounded-2xl h-14 mb-6 px-4">
        <input
          ref={inputRef}
          type="text"
          className="flex-1 h-full text-right text-gray-800 text-base outline-none px-3 bg-white"
          style={{ backgroundColor: "white" }}
          placeholder={getCurrentSuggestion()}
          value={searchQuery}
          onChange={(e) => handleTextChange(e.target.value)}
          onKeyPress={(e) => e.key === "Enter" && handleSearch(true)}
          autoFocus={isInputReady}
        />
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto">{renderTabContent()}</div>
    </div>
  </div>
)}

      {/* Fullscreen Loading Overlay - Only during redirect */}
      {isRedirecting && (
        <div className="fixed inset-0 bg-white bg-opacity-98 flex items-center justify-center z-[9999]">
          <img
            className="spinner-image"
            src="/logo/ajour-gif.gif"
            alt="در حال رفتن به نتایج"
            style={{
              width: "150px",
              height: "150px",
            }}
          />
        </div>
      )}
    </div>
  );
};

export default SearchBars;


//////////
import React, { useState, useRef, useEffect, useContext } from "react";
import axios from "axios";
import { CityContext } from "./CityContext";
import CitySelector from "./CitySelector";
import SearchIcon from "@mui/icons-material/Search";
import { useRouter } from "next/router";
import SmallCard from "../cards/SmallCard";
import { Snackbar, Alert } from "@mui/material";

const RealEstateCard = ({ realstate, circle_size }) => (
  <div className="bg-white p-4 rounded-lg shadow-md border border-gray-200">
    نمایش کارت املاک
  </div>
);

const suggestionsMap = {
  buySell: [
    "مثلا : خرید خانه ",
    "مثلا : ویلایی ",
    "مثلا تجاری ",
    "مثلا : اجاره آپارتمان",
  ],
  agents: [
    "جستجو مشاور : مثلا محمد دهقان",
    "جستجو مشاور املاک...",
    "مشاور املاک متخصص...",
  ],
};

const estateHints = [
  "آپارتمان",
  "خانه ویلایی",
  "زمین مسکونی",
  "مغازه",
  "اجاره آپارتمان",
  "اجاره خانه ویلایی",
  "باغ و باغچه",
  "زمین صنعتی",
];

const SEARCH_TIMEOUT = 15000;
const TYPING_DELAY = 600;

const categoriesData = [
  {
    id: 3,
    name: "خرید صنعتی",
    description: null,
    status: "1",
    has_parent: "0",
    has_child: "0",
    parent_id: "0",
    sort_order: "1",
    avatar: "industry",
    created_at: "2021-01-03T21:56:25.000000Z",
    updated_at: "2021-01-03T21:56:25.000000Z",
    type: "sell",
  },
  {
    id: 6,
    name: "اجاره صنعتی",
    description: "اجاره انواع واحد های صنعتی",
    status: "1",
    has_parent: "0",
    has_child: "0",
    parent_id: "0",
    sort_order: "27",
    avatar: "rent_industrial",
    created_at: "2024-04-06T16:01:02.000000Z",
    updated_at: "2024-04-06T16:01:02.000000Z",
    type: "rent",
  },
  {
    id: 16,
    name: "خرید آپارتمان",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "1",
    sort_order: "16",
    avatar: "sell_apartment",
    created_at: null,
    updated_at: null,
    type: "sell",
  },
  {
    id: 17,
    name: "خرید خانه ویلایی",
    description: "فروش انواع خانه های ویلایی",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "1",
    sort_order: "17",
    avatar: "sell_industrial_land",
    created_at: "2024-04-06T15:18:54.000000Z",
    updated_at: "2024-04-06T15:18:54.000000Z",
    type: "sell",
  },
  {
    id: 18,
    name: "خرید زمین مسکونی",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "18",
    avatar: "sell_residental_land",
    created_at: "2021-01-03T21:56:25.000000Z",
    updated_at: "2021-01-03T21:56:25.000000Z",
    type: "sell",
  },
  {
    id: 19,
    name: "خرید زمین تجاری و اداری",
    description: "دسته بندی زمین های تجاری و اداری",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "19",
    avatar: "sell_office_land",
    created_at: "2024-04-06T15:11:50.000000Z",
    updated_at: "2024-04-06T15:11:50.000000Z",
    type: "sell",
  },
  {
    id: 20,
    name: "خرید زمین صنعتی ",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "20",
    avatar: "sell_industrial_land",
    created_at: "2024-04-06T15:13:10.000000Z",
    updated_at: "2024-04-06T15:13:10.000000Z",
    type: "sell",
  },
  {
    id: 21,
    name: "خرید باغ و باغچه",
    description: "فروش انواع باغ و باغچه",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "21",
    avatar: "sell_industrial",
    created_at: "2024-04-06T15:54:38.000000Z",
    updated_at: "2024-04-06T15:54:38.000000Z",
    type: "sell",
  },
  {
    id: 22,
    name: "خرید زمین زراعی\n",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "22",
    avatar: "sell_farm_land",
    created_at: "2024-04-06T15:15:48.000000Z",
    updated_at: "2024-04-06T15:15:48.000000Z",
    type: "sell",
  },
  {
    id: 23,
    name: "خرید مغازه\n",
    description: null,
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "4",
    sort_order: "23",
    avatar: "sell_store",
    created_at: "2024-04-06T15:48:19.000000Z",
    updated_at: "2024-04-06T15:48:19.000000Z",
    type: "sell",
  },
  {
    id: 24,
    name: "خرید دفتر کار و اداری",
    description: "انواع دفتر کار ، سالن و اداری",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "4",
    sort_order: "24",
    avatar: "sell_office",
    created_at: "2024-04-06T15:50:53.000000Z",
    updated_at: "2024-04-06T15:50:53.000000Z",
    type: "sell",
  },
  {
    id: 25,
    name: "اجاره آپارتمان",
    description: "اجاره انواع آپارتمان",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "5",
    sort_order: "25",
    avatar: "rent_apartment",
    created_at: "2024-04-06T15:59:02.000000Z",
    updated_at: "2024-04-06T15:59:02.000000Z",
    type: "rent",
  },
  {
    id: 26,
    name: "اجاره خانه ویلایی",
    description: "اجاره انواع خانه های ویلایی",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "5",
    sort_order: "26",
    avatar: "rent_villa",
    created_at: "2024-04-06T15:56:47.000000Z",
    updated_at: "2024-04-06T15:56:47.000000Z",
    type: "rent",
  },
  {
    id: 27,
    name: "اجاره مغازه",
    description: "اجاره انواع مغازه",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "7",
    sort_order: "27",
    avatar: "sell_store",
    created_at: "2024-04-06T16:08:35.000000Z",
    updated_at: "2024-04-06T16:08:35.000000Z",
    type: "rent",
  },
  {
    id: 28,
    name: "اجاره دفتر کار و اداری",
    description: "اجاره انواع دفتر کار، مطب و واحد اداری",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "7",
    sort_order: "28",
    avatar: "rent_office",
    created_at: "2024-04-06T16:09:35.000000Z",
    updated_at: "2024-04-06T16:09:35.000000Z",
    type: "rent",
  },
  {
    id: 65,
    name: "زمین هکتاری",
    description: "زمین هکتاری",
    status: "1",
    has_parent: "1",
    has_child: "0",
    parent_id: "2",
    sort_order: "1",
    avatar: "hectare_land",
    created_at: "2025-02-12T18:19:41.000000Z",
    updated_at: "2025-02-12T18:19:41.000000Z",
    type: "sell",
  },
];

const SearchBars = ({ realstates }) => {
  const router = useRouter();
  const { currentCity, isLoading } = useContext(CityContext);
  // State management
  const [activeTab, setActiveTab] = useState("buySell");
  const [searchQuery, setSearchQuery] = useState("");
  const [properties, setProperties] = useState([]);
  const [agents, setAgents] = useState([]);
  const [loading, setLoading] = useState(false);
  const [loadingAgents, setLoadingAgents] = useState(false);
  const [isRedirecting, setIsRedirecting] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [currentSuggestionIndex, setCurrentSuggestionIndex] = useState(0);
  const [isInputReady, setIsInputReady] = useState(false);
  const [searchStatus, setSearchStatus] = useState("جستجو...");
  const [networkStatus, setNetworkStatus] = useState({
    isConnected: true,
    isInternetReachable: true,
  });
  const [selectedCityName, setSelectedCityName] = useState();
  const [selectedCityId, setSelectedCityId] = useState();
  const [showCityModal, setShowCityModal] = useState(false);
  const [search_category, set_search_category] = useState([]);
  const [search_neighborhoods, set_search_neighborhoods] = useState([]);
  const [searchHistory, setSearchHistory] = useState([]);
  const [showAllNeighborhoods, setShowAllNeighborhoods] = useState(false);
  const [lastHintPressed, setLastHintPressed] = useState(null);
  const [suggestionDirection, setSuggestionDirection] = useState("down");
  const [snackOpen, setSnackOpen] = useState(false);
  const [snack, setSnack] = useState("");

  // Refs
  const inputRef = useRef(null);
  const suggestionIntervalRef = useRef(null);
  const loadingTimeoutRef = useRef(null);
  const progressIntervalRef = useRef(null);
  const typingTimeoutRef = useRef(null);

  const [cities, setCities] = useState([]);

  const getDefaultCities = () => [
    { id: 1, title: "تهران" },
    { id: 2, title: "رباط کریم" },
    { id: 3, title: "کرج" },
    { id: 4, title: "اصفهان" },
    { id: 5, title: "مشهد" },
  ];

  // Helper function to calculate string similarity
  const calculateSimilarity = (str1, str2) => {
    if (!str1 || !str2) return 0;
    
    const cleanStr1 = str1.replace(/\s+/g, '').toLowerCase();
    const cleanStr2 = str2.replace(/\s+/g, '').toLowerCase();
    
    if (cleanStr1.includes(cleanStr2) || cleanStr2.includes(cleanStr1)) {
      return 1;
    }
    
    const set1 = new Set(cleanStr1.split(''));
    const set2 = new Set(cleanStr2.split(''));
    
    const intersection = new Set([...set1].filter(x => set2.has(x)));
    const union = new Set([...set1, ...set2]);
    
    return union.size > 0 ? intersection.size / union.size : 0;
  };

  // Helper function to extract main category from search query
  const extractMainCategory = (searchQuery) => {
    if (!searchQuery || typeof searchQuery !== 'string') return '';
    
    // Clean the query - remove common extra details
    const cleanQuery = searchQuery
      .replace(/در\s+[\u0600-\u06FF\uFB8A\u067E\u0686\u06AF\s]+$/g, '') // Remove location at the end
      .replace(/\s+دو\s+خوابه/gi, '')
      .replace(/\s+سه\s+خوابه/gi, '')
      .replace(/\s+چهار\s+خوابه/gi, '')
      .replace(/\s+نوساز/gi, '')
      .replace(/\s+نو\s+ساز/gi, '')
      .replace(/\s+نو/gi, '')
      .replace(/\s+قدیمی/gi, '')
      .replace(/\s+تازه\s+ساز/gi, '')
      .replace(/\s+نوسازی/gi, '')
      .replace(/\s+متراژ\s+\d+/gi, '')
      .replace(/\s+\d+\s+متری/gi, '')
      .replace(/\s+تخفیف\s+دارد/gi, '')
      .replace(/\s+ویژه/gi, '')
      .replace(/\s+عالی/gi, '')
      .replace(/\s+خوب/gi, '')
      .replace(/\s+مناسب/gi, '')
      .replace(/\s+ارزان/gi, '')
      .replace(/\s+گران/gi, '')
      .replace(/\s+لوکس/gi, '')
      .replace(/\s+مدرن/gi, '')
      .replace(/\s+شیک/gi, '')
      .trim();
    
    return cleanQuery;
  };

  // Function to find ALL matching categories
  const findAllMatchingCategories = (searchQuery) => {
    if (!searchQuery || typeof searchQuery !== 'string') {
      return [];
    }
    
    const normalizedQuery = searchQuery.replace(/\s+/g, " ").trim().toLowerCase();
    const matchedCategories = new Map();
    
    // 1. First, find exact or partial matches in category names
    categoriesData.forEach(category => {
      const categoryName = category.name.toLowerCase();
      
      // Check if search query contains category name or vice versa
      if (categoryName.includes(normalizedQuery) || normalizedQuery.includes(categoryName)) {
        matchedCategories.set(category.id, category);
      }
      
      // Check individual words in search query
      const queryWords = normalizedQuery.split(' ').filter(word => word.length > 1);
      const categoryWords = categoryName.split(' ').filter(word => word.length > 1);
      
      // Check for word matches
      const hasWordMatch = queryWords.some(queryWord => 
        categoryWords.some(categoryWord => 
          categoryWord.includes(queryWord) || queryWord.includes(categoryWord)
        )
      );
      
      if (hasWordMatch) {
        matchedCategories.set(category.id, category);
      }
    });
    
    // If we found matches, return them sorted by relevance
    if (matchedCategories.size > 0) {
      return Array.from(matchedCategories.values());
    }
    
    // Fallback: Return all categories that have any matching word
    const allQueryWords = normalizedQuery.split(' ').filter(word => word.length > 1);
    
    categoriesData.forEach(category => {
      const categoryName = category.name.toLowerCase();
      const hasAnyMatch = allQueryWords.some(word => categoryName.includes(word));
      
      if (hasAnyMatch) {
        matchedCategories.set(category.id, category);
      }
    });
    
    return Array.from(matchedCategories.values());
  };

  // Effects
  useEffect(() => {
    if (currentCity && !isLoading) {
      // fetchData(currentCity.id);
    }
  }, [currentCity, isLoading]);

  useEffect(() => {
    // Reset redirecting spinner when route changes complete
    const handleRouteChangeComplete = () => {
      setIsRedirecting(false);
    };

    router.events.on("routeChangeComplete", handleRouteChangeComplete);
    return () => {
      router.events.off("routeChangeComplete", handleRouteChangeComplete);
    };
  }, [router]);

  useEffect(() => {
    if (lastHintPressed) {
      handleSearch(true);
    }
  }, [lastHintPressed]);

  // Load search history from localStorage on component mount
  useEffect(() => {
    const loadSearchHistory = async () => {
      try {
        const history = localStorage.getItem("realEstateSearchHistory");
        if (history) {
          const parsedHistory = JSON.parse(history);
          // Keep only the last 3 searches
          const recentHistory = parsedHistory.slice(0, 3);
          setSearchHistory(recentHistory);
        }
      } catch (error) {
        console.error("Failed to load search history", error);
      }
    };
    loadSearchHistory();
  }, []);

  useEffect(() => {
    if (activeTab && !searchQuery && !showModal) {
      suggestionIntervalRef.current = setInterval(() => {
        setSuggestionDirection("up");

        setTimeout(() => {
          setCurrentSuggestionIndex((prev) =>
            prev >= suggestionsMap[activeTab].length - 1 ? 0 : prev + 1
          );

          setTimeout(() => {
            setSuggestionDirection("down");
          }, 100);
        }, 500);
      }, 3000);
    } else {
      clearInterval(suggestionIntervalRef.current);
      setCurrentSuggestionIndex(0);
      setSuggestionDirection("down");
    }
    return () => clearInterval(suggestionIntervalRef.current);
  }, [activeTab, searchQuery, showModal]);

  useEffect(() => {
    if (showModal) {
      const timer = setTimeout(() => {
        setIsInputReady(true);
        inputRef.current?.focus();
      }, 300);
      return () => clearTimeout(timer);
    } else {
      setIsInputReady(false);
    }
  }, [showModal]);

  // Helper functions
  const handleSnackbar = (message) => {
    setSnack(message);
    setSnackOpen(true);
  };

  const renderSnackBar = () => {
    return (
      <Snackbar
        open={snackOpen}
        autoHideDuration={4000}
        onClose={() => setSnackOpen(false)}
        anchorOrigin={{ vertical: "top", horizontal: "center" }}
        sx={{
          "& .MuiSnackbarContent-root": {
            fontSize: "1.2rem", // Larger font
            padding: "16px 24px", // More padding
            minWidth: "400px", // Minimum width
          },
        }}
      >
        <Alert
          onClose={() => setSnackOpen(false)}
          severity="warning"
          sx={{ width: "100%" }}
        >
          {snack}
        </Alert>
      </Snackbar>
    );
  };

  const fetch_cities_from_data_base = async () =>  {
    try {
      const response = await axios.get(
        "https://api.ajur.app/api/search-cities",
        {
          params: { title: '' || "" },
          timeout: 5000,
        }
      );
      setCities(response.data?.items || getDefaultCities());
      console.log("now cities:", response.data?.items);
    } catch (error) {
      console.error("Error fetching cities:", error);
      setCities(getDefaultCities());
    }
  }

  const getCurrentSuggestion = () => {
    if (searchQuery) return searchQuery;
    if (!activeTab) return "جستجو...";
    return suggestionsMap[activeTab][currentSuggestionIndex] || "جستجو...";
  };

  const getNextSuggestion = () => {
    if (!activeTab) return "جستجو...";
    const nextIndex =
      currentSuggestionIndex >= suggestionsMap[activeTab].length - 1
        ? 0
        : currentSuggestionIndex + 1;
    return suggestionsMap[activeTab][nextIndex] || "جستجو...";
  };

  const saveToHistory = async (query) => {
    if (!query.trim()) return;
    try {
      const updatedHistory = [
        query,
        ...searchHistory.filter(
          (item) => item.toLowerCase() !== query.toLowerCase()
        ),
      ].slice(0, 3); // Keep only last 3 searches
      setSearchHistory(updatedHistory);
      localStorage.setItem(
        "realEstateSearchHistory",
        JSON.stringify(updatedHistory)
      );
    } catch (error) {
      console.error("Failed to save search history", error);
    }
  };

  const handleTabPress = (tabId) => {
    if (tabId === "agents") {
      if (!currentCity || isLoading) {
        setSearchStatus("لطفاً ابتدا یک شهر را انتخاب کنید");
        return;
      }
      getAgentsCall("all", currentCity.id);
    }
    setActiveTab(tabId);
    setSearchQuery("");
    setSearchStatus("جستجو...");
  };

  const handleCloseModal = () => {
    setActiveTab("buySell");
    setShowModal(false);
    setIsRedirecting(false);
    clearTimeout(loadingTimeoutRef.current);
    clearInterval(progressIntervalRef.current);
  };

  const handleHintPress = (hint) => {
    setSearchQuery(hint);
    setLastHintPressed(hint);
    handleSearch(true);
  };

  const handleTextChange = (text) => {
    setSearchQuery(text);
    if (typingTimeoutRef.current) {
      clearTimeout(typingTimeoutRef.current);
    }
    if (text.trim().length > 0) {
      typingTimeoutRef.current = setTimeout(() => {
        handleSearch(false);
      }, TYPING_DELAY);
    }
  };

  const getAgentsCall = async (searchTerm) => {
    try {
      setLoadingAgents(true);
      setSearchStatus("در حال جستجوی مشاورین...");
      const response = await axios.get(
        "https://api.ajur.app/api/agents-search",
        {
          params: { title: searchTerm, limit: 20, city: currentCity.id },
          timeout: SEARCH_TIMEOUT,
        }
      );
      setAgents(response.data.agents || []);
      setSearchStatus(`${response.data.agents.length} مشاور یافت شد`);
    } catch (error) {
      console.error("Agent search failed:", error);
      setSearchStatus("خطا در جستجوی مشاورین");
    } finally {
      setLoadingAgents(false);
    }
  };

  const navigateToCategory = (categoryName, neighborhoodName = null) => {
    if (!categoryName || !currentCity) {
      console.error("Missing category name or city");
      handleSnackbar("خطا در انتقال به صفحه دسته‌بندی");
      return;
    }

    handleCloseModal();
    
    // Build clean URL path
    let path = `/${currentCity.title}/${encodeURIComponent(categoryName)}`;
    
    // Store context in localStorage if needed for the next page
    const searchContext = {
      originalQuery: searchQuery,
      selectedCategory: categoryName,
      neighborhood: neighborhoodName,
      timestamp: Date.now()
    };
    
    localStorage.setItem("lastSearchContext", JSON.stringify(searchContext));
    
    console.log("Navigating to:", path);
    
    // Show spinner during redirect
    setIsRedirecting(true);
    
    // Navigate with clean URL
    router.push(path);
  };

  const handleSearch = async (isManualSearch = true) => {
    if (!currentCity || isLoading) {
      setSearchStatus("لطفاً ابتدا یک شهر را انتخاب کنید");
      return;
    }
    if (!searchQuery.trim()) {
      return;
    }

    console.log(`Searching for "${searchQuery}" in ${activeTab} tab`);

    try {
      setLoading(true);
      setSearchStatus("در حال جستجو...");

      if (isManualSearch) {
        await saveToHistory(searchQuery);
      }

      progressIntervalRef.current = setInterval(() => {
        setSearchStatus((prev) =>
          prev.includes("...") ? "در حال جستجو" : prev + "."
        );
      }, 500);

      switch (activeTab) {
        case "buySell":
          try {
            // Find all matching categories
            const matchedCategories = findAllMatchingCategories(searchQuery);
            console.log("Found matching categories:", matchedCategories);
            
            if (matchedCategories.length === 0) {
              setSearchStatus(`هیچ دسته‌بندی‌ای برای "${searchQuery}" یافت نشد`);
              setProperties([]);
              break;
            }
            
            // Create display items for each matched category
            const displayItems = await Promise.all(
              matchedCategories.map(async (category, index) => {
                try {
                  // Fetch neighborhoods for this category
                  const response = await axios.post(
                    "https://api.ajur.app/api/search-intent",
                    {
                      query: category.name,
                      original_query: searchQuery,
                      cityid: currentCity.id,
                      category_id: category.id,
                      fuzzy_match: true,
                    },
                    { timeout: 8000 }
                  );
                  
                  const categoryData = response.data && response.data[0];
                  const neighborhoods = categoryData?.neighborhoods || [];
                  
                  return {
                    id: `category-${category.id}-${Date.now()}`,
                    category: category.name,
                    category_array: category,
                    categories_array: matchedCategories, // Store all matched categories
                    neighborhoods: neighborhoods,
                    propertyCounts: neighborhoods.reduce((acc, curr) => {
                      acc[curr.name] = curr.property_count;
                      return acc;
                    }, {}),
                    filters: { category_name: category.name },
                    chips: neighborhoods
                      .filter((n) => n.property_count > 0)
                      .slice(0, 5)
                      .map((n) => ({
                        label: `${n.name} (${n.property_count})`,
                        value: n.name,
                      })),
                    isEmpty: neighborhoods.every((n) => n.property_count === 0),
                    isPrimary: index === 0,
                  };
                } catch (error) {
                  console.error(`Error fetching neighborhoods for ${category.name}:`, error);
                  return {
                    id: `category-${category.id}-${Date.now()}`,
                    category: category.name,
                    category_array: category,
                    categories_array: matchedCategories,
                    neighborhoods: [],
                    propertyCounts: {},
                    filters: { category_name: category.name },
                    chips: [],
                    isEmpty: true,
                    isPrimary: index === 0,
                  };
                }
              })
            );
            
            setProperties(displayItems);

            // Update search status
            if (displayItems.length === 1) {
              const item = displayItems[0];
              const totalProperties = Object.values(item.propertyCounts).reduce((sum, count) => sum + count, 0);
              setSearchStatus(
                totalProperties > 0 
                  ? `${item.category} در ${currentCity.title} (${totalProperties} ملک)`
                  : `${item.category} در ${currentCity.title} (موجودی ندارد)`
              );
            } else {
              const categoryNames = displayItems.map(item => item.category).join("، ");
              setSearchStatus(`${displayItems.length} دسته‌بندی یافت شد: ${categoryNames}`);
            }
            
          } catch (error) {
            console.error("Search error:", error);
            
            // Fallback: Try to find categories without API call
            const matchedCategories = findAllMatchingCategories(searchQuery);
            if (matchedCategories.length > 0) {
              const displayItems = matchedCategories.map((category, index) => ({
                id: `fallback-${category.id}-${Date.now()}`,
                category: category.name,
                category_array: category,
                categories_array: matchedCategories,
                neighborhoods: [],
                propertyCounts: {},
                filters: { category_name: category.name },
                chips: [],
                isEmpty: true,
                isPrimary: index === 0,
              }));
              
              setProperties(displayItems);
              setSearchStatus(`${matchedCategories.length} دسته‌بندی یافت شد (اطلاعات محلات در دسترس نیست)`);
            } else {
              setSearchStatus("خطا در دریافت اطلاعات. لطفاً دوباره تلاش کنید");
              setProperties([]);
            }
          }
          break;

        case "agents":
          await getAgentsCall(searchQuery);
          break;

        default:
          setSearchStatus("لطفاً یک تب معتبر را انتخاب کنید");
          return;
      }
    } catch (error) {
      console.error("Search error:", error);
      clearTimeout(loadingTimeoutRef.current);
      clearInterval(progressIntervalRef.current);
      setSearchStatus("خطا در جستجو");
    } finally {
      setLoading(false);
    }
  };

  const set_modal_active = (status) => {
    if (!currentCity || isLoading) {
      handleSnackbar("لطفاً ابتدا یک شهر را انتخاب کنید");
      // Trigger the CitySelector modal to open
      const citySelectorButton = document.querySelector(
        '[data-testid="citySelectorButton"]'
      );
      if (citySelectorButton) {
        citySelectorButton.click();
      }
      return;
    }
    setShowAllNeighborhoods(false);
    setProperties([]);
    setSearchQuery("");
    setShowModal(true);

    const timer = setTimeout(() => {
      setIsInputReady(true);
      inputRef.current?.focus();
    }, 500);
    return () => clearTimeout(timer);
  };

  const handleHomeClick = () => {
    router.push("/");
  };

  const renderSpinner = () => (
    <div className="flex justify-center items-center py-5">
      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"></div>
    </div>
  );

  const renderCategoryCard = (item, itemIndex) => {
    // Check if this item has multiple categories
    const hasMultipleCategories = item.categories_array && item.categories_array.length > 1;
    
    return (
      <div
        key={item.id}
        className="bg-white rounded-lg p-4 shadow-sm border border-gray-200 mb-4"
      >
        {/* Category Header */}
        <div className="flex flex-row-reverse items-center justify-between pb-3 border-b border-gray-100">
          <div className="flex flex-col items-end">
            <a onClick={() => navigateToCategory(item.category)}>
            <div className="text-blue-800 font-bold text-sm">
              {item.category} در {currentCity.title}
              <span className="text-gray-500 text-sm">
                {` (${Object.values(item.propertyCounts).reduce(
                  (sum, count) => sum + count,
                  0
                )} مورد)`}
              </span>
            </div>
            </a>
            
            {/* Show other matched categories if there are multiple */}
            {hasMultipleCategories && item.categories_array.length > 1 && (
              <div className="mt-1 text-xs text-gray-500">
                همچنین در دسته‌های:{" "}
                {item.categories_array
                  .filter((cat, idx) => idx !== itemIndex)
                  .map(cat => cat.name)
                  .join("، ")}
              </div>
            )}
          </div>
          
          <button
            className="flex flex-row-reverse items-center text-blue-600 hover:text-blue-800"
            onClick={() => navigateToCategory(item.category)}
          >
            <span className="text-sm ml-1">همه موارد</span>
            <span>‹</span>
          </button>
        </div>

        {/* Neighborhoods */}
        {item.neighborhoods.length > 0 && (
          <div className="flex flex-row-reverse flex-wrap gap-2 mt-3">
            {(showAllNeighborhoods
              ? item.neighborhoods
              : item.neighborhoods.slice(0, 3)
            ).map((neighborhood, index) => {
              const propertyCount = neighborhood.property_count || 0;
              return (
                <button
                  key={`${item.id}-${neighborhood.name}-${index}`}
                  className={`px-3 py-1 rounded-full text-sm border bg-green-50 text-gray-700 border-green-200 hover:bg-green-100`}
                  onClick={() =>
                    navigateToCategory(item.category, neighborhood.name)
                  }
                >
                  {neighborhood.name}
                  <span className="text-gray-500 text-xs mr-1">
                    {` (${propertyCount} ملک)`}
                  </span>
                </button>
              );
            })}
          </div>
        )}

        {/* Show all neighborhoods button */}
        {item.neighborhoods.length > 10 && !showAllNeighborhoods && (
          <button
            className="w-full py-2 text-center text-blue-600 hover:text-blue-800 text-sm mt-2"
            onClick={() => setShowAllNeighborhoods(true)}
          >
            نمایش همه محلات ({item.neighborhoods.length - 10} مورد دیگر)
          </button>
        )}
        
        {/* No neighborhoods message */}
        {item.neighborhoods.length === 0 && (
          <div className="text-center py-3 text-gray-500 text-sm">
            هیچ ملکی در این دسته‌بندی یافت نشد
          </div>
        )}
      </div>
    );
  };

  const renderTabContent = () => {
    switch (activeTab) {
      case "buySell":
        return (
          <div className="flex-1 py-2">
            {loading ? (
              renderSpinner()
            ) : (
              <div className="space-y-4">
                {/* Show recent searches before showing properties */}
                {searchHistory.length > 0 && properties.length === 0 && !loading && (
                  <div className="text-right mb-6">
                    <h3 className="text-gray-500 text-sm mb-2">جستجوهای اخیر:</h3>
                    <div className="flex flex-row-reverse flex-wrap gap-2">
                      {searchHistory.map((historyItem, index) => (
                        <div
                          key={`history-${index}`}
                          className="flex flex-row-reverse items-center bg-gray-100 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-200 border border-gray-300"
                          onClick={() => handleHintPress(historyItem)}
                        >
                          <span className="text-gray-700 text-sm ml-2">
                            {historyItem}
                          </span>
                          <button
                            className="text-gray-500 hover:text-gray-700 text-xs mr-2"
                            onClick={(e) => {
                              e.stopPropagation();
                              const updatedHistory = searchHistory.filter(
                                (_, i) => i !== index
                              );
                              setSearchHistory(updatedHistory);
                              localStorage.setItem(
                                "realEstateSearchHistory",
                                JSON.stringify(updatedHistory)
                              );
                            }}
                          >
                            ×
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                {/* Show search hints before properties */}
                {properties.length === 0 && !loading && (
                  <div className="text-right">
                    <h3 className="text-gray-500 text-sm mb-2">
                      پیشنهادهایی برای جستجو:
                    </h3>
                    <div className="flex flex-row-reverse flex-wrap gap-2">
                      {estateHints.map((hint, index) => (
                        <button
                          key={`hint-${index}`}
                          className="bg-gray-600 text-white px-3 py-1 rounded-full text-sm hover:bg-gray-700"
                          onClick={() => handleHintPress(hint)}
                        >
                          {hint}
                        </button>
                      ))}
                    </div>
                  </div>
                )}
                
                {/* Show matched properties */}
                {properties.length > 0 && (
                  <div className="space-y-4">
                    {properties.map((item, index) => renderCategoryCard(item, index))}
                  </div>
                )}
              </div>
            )}
          </div>
        );

      case "agents":
        return (
          <div className="flex-1">
            {loadingAgents ? (
              renderSpinner()
            ) : (
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 m-4">
                {agents.map((agent, index) => (
                  <SmallCard
                    key={index}
                    realEstate={agent}
                    profileImageKey="profile_url"
                    compact={true}
                  />
                ))}
              </div>
            )}
            {agents.length === 0 && !loadingAgents && (
              <div className="text-center text-gray-500 py-5 col-span-full">
                مشاوری یافت نشد
              </div>
            )}
          </div>
        );

      default:
        return (
          <div className="flex-1 py-2">
            <div className="text-center text-gray-500 py-5">
              لطفاً یک تب را انتخاب کنید
            </div>
          </div>
        );
    }
  };

  return (
    <div className="w-full py-2 px-3 bg-white">
      {/* Header with Logo and Search Bar */}
      <div className="flex items-center gap-4">
        {/* Search Bar taking remaining space */}
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <CitySelector
              handleCitySelect={(city) => {
                setShowAllNeighborhoods(false);
              }}
            />

            <div
              className="flex-1 flex flex-row-reverse items-center bg-gray-50 rounded-2xl border border-gray-300 h-14 px-4 cursor-pointer shadow-sm hover:shadow-md transition-shadow relative overflow-hidden"
              onClick={() => set_modal_active(true)}
            >
              {/* Animated Suggestion Container */}
              <div className="flex-1 text-right overflow-hidden relative h-6">
                {/* Current Suggestion */}
                <div
                  className={`absolute inset-0 flex items-center transition-all duration-500 ease-in-out ${
                    suggestionDirection === "up"
                      ? "transform -translate-y-full opacity-0"
                      : "transform translate-y-0 opacity-100"
                  }`}
                >
                  <span className="text-gray-600 text-base overflow-hidden whitespace-nowrap overflow-ellipsis w-full">
                    {getCurrentSuggestion()}
                  </span>
                </div>

                {/* Next Suggestion */}
                <div
                  className={`absolute inset-0 flex items-center transition-all duration-500 ease-in-out ${
                    suggestionDirection === "up"
                      ? "transform translate-y-0 opacity-100"
                      : "transform translate-y-full opacity-0"
                  }`}
                >
                  <span className="text-gray-600 text-base overflow-hidden whitespace-nowrap overflow-ellipsis w-full">
                    {getNextSuggestion()}
                  </span>
                </div>
              </div>

              <button
                className="w-10 h-10 rounded-xl flex items-center justify-center mr-2 hover:bg-gray-200 transition-colors"
                onClick={() => set_modal_active(true)}
                aria-label="جستجو"
              >
                <SearchIcon style={{ fontSize: 22 }} />
              </button>
            </div>

            <button
              onClick={handleHomeClick}
              className="flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity"
              aria-label="رفتن به صفحه اصلی"
            >
              <img
                src="/logo/web-logo-text.png"
                alt="آجر"
                className="h-8 w-auto"
              />
            </button>
          </div>
        </div>
        {renderSnackBar()}
      </div>

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 z-50">
          <div
            className="absolute inset-0 bg-black bg-opacity-50"
            onClick={handleCloseModal}
          />
          {/* Top-down panel: appears from above and replaces the searchbar */}
          <div
            className={`absolute top-0 left-0 right-0 bg-white rounded-b-3xl p-6 max-h-[90vh] overflow-auto flex flex-col animate__animated animate__slideInDown`}
          >
            {/* Floating close button in the corner */}
            <button
              onClick={handleCloseModal}
              aria-label="بستن"
              style={{
                position: "absolute",
                top: 16,
                right: 16,
                zIndex: 80,
                background: "transparent",
                border: "none",
                fontSize: "1.35rem",
                cursor: "pointer",
                padding: 6,
                lineHeight: 1,
              }}
            >
              ✕
            </button>

            {/* Tab Header with CitySelector */}
            <div className="flex flex-row-reverse items-center mb-4 gap-3">
              {/* Tabs Container - takes remaining space */}
              <div className="flex-1 flex justify-between gap-3">
                {Object.entries(suggestionsMap)
                  .filter(([tabId]) => tabId !== "jobs") // Remove jobs tab
                  .map(([tabId]) => (
                    <button
                      key={tabId}
                      className={`flex-1 py-3 px-3 rounded-xl text-sm font-medium transition-colors ${
                        activeTab === tabId
                          ? "bg-red-500 text-white"
                          : "bg-gray-100 text-gray-500 hover:bg-gray-200"
                      }`}
                      onClick={() => handleTabPress(tabId)}
                    >
                      {tabId === "buySell" ? "املاک" : "مشاورین"}
                    </button>
                  ))}
              </div>
              
              {/* CitySelector placed to the left of tabs */}
              <div className="flex-shrink-0">
                <CitySelector
                  handleCitySelect={(city) => {
                    // When city is changed in modal, refresh the search if needed
                    setShowAllNeighborhoods(false);
                    if (searchQuery) {
                      handleSearch(true);
                    }
                  }}
                />
              </div>
            </div>

            {/* Search Input */}
            <div className="flex flex-row-reverse items-center bg-white border-2 border-red-500 rounded-2xl h-14 mb-6 px-4">
              <input
                ref={inputRef}
                type="text"
                className="flex-1 h-full text-right text-gray-800 text-base outline-none px-3 bg-white"
                style={{ backgroundColor: "white" }}
                placeholder={getCurrentSuggestion()}
                value={searchQuery}
                onChange={(e) => handleTextChange(e.target.value)}
                onKeyPress={(e) => e.key === "Enter" && handleSearch(true)}
                autoFocus={isInputReady}
              />
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto">{renderTabContent()}</div>
          </div>
        </div>
      )}

      {/* Fullscreen Loading Overlay - Only during redirect */}
      {isRedirecting && (
        <div className="fixed inset-0 bg-white bg-opacity-98 flex items-center justify-center z-[9999]">
          <img
            className="spinner-image"
            src="/logo/ajour-gif.gif"
            alt="در حال رفتن به نتایج"
            style={{
              width: "150px",
              height: "150px",
            }}
          />
        </div>
      )}
    </div>
  );
};

export default SearchBars;
